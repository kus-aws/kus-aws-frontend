import{j as e,c as z,a as R,u as F}from"./index-B3lgfvlw.js";import{r as n}from"./vendor-CwHBbTcV.js";import{B as f}from"./button-K7KoypZF.js";import{C as y,a as k}from"./card-B1O2FdMD.js";import{T,d as $,e as D,L as I,A as E,R as L,f as U,g as S,C as _,h as A}from"./lucide-ifMYtCOH.js";import{c as P}from"./api-CGppXN6G.js";import{g as B,a as K}from"./categories-BlY_H3dN.js";const M=n.forwardRef(({className:s,type:d,...c},u)=>e.jsx("input",{type:d,className:z("flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",s),ref:u,...c}));M.displayName="Input";function Q({messageId:s,onFeedback:d,onComment:c,className:u=""}){const[a,i]=n.useState(null),[g,l]=n.useState(!1),[m,o]=n.useState(""),x=h=>{i(h),d?.(h,s),h==="positive"&&setTimeout(()=>i(null),2e3)},p=()=>{m.trim()&&(c?.(m.trim(),s),o(""),l(!1))},N=h=>{h.key==="Enter"&&!h.shiftKey&&(h.preventDefault(),p())};return e.jsxs("div",{className:`flex items-center space-x-2 mt-2 ${u}`,children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(f,{variant:"ghost",size:"sm",onClick:()=>x("positive"),className:`h-8 px-2 ${a==="positive"?"bg-green-100 text-green-700 hover:bg-green-200":"hover:bg-gray-100"}`,"aria-label":"긍정적 피드백","aria-pressed":a==="positive",children:e.jsx(T,{className:"w-4 h-4"})}),e.jsx(f,{variant:"ghost",size:"sm",onClick:()=>x("negative"),className:`h-8 px-2 ${a==="negative"?"bg-red-100 text-red-700 hover:bg-red-200":"hover:bg-gray-100"}`,"aria-label":"부정적 피드백","aria-pressed":a==="negative",children:e.jsx($,{className:"w-4 h-4"})})]}),e.jsx(f,{variant:"ghost",size:"sm",onClick:()=>l(!g),className:"h-8 px-2 hover:bg-gray-100","aria-label":"코멘트 추가","aria-expanded":g,children:e.jsx(D,{className:"w-4 h-4"})}),a&&e.jsx("span",{className:"text-sm text-gray-600 ml-2",children:a==="positive"?"👍 도움이 되었습니다":"👎 개선이 필요합니다"}),g&&e.jsxs("div",{className:"flex-1 ml-2",children:[e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("textarea",{value:m,onChange:h=>o(h.target.value),onKeyPress:N,placeholder:"의견을 입력해주세요...",className:"flex-1 px-3 py-2 border border-gray-300 rounded-md text-sm resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent",rows:2,maxLength:500}),e.jsxs("div",{className:"flex flex-col space-y-1",children:[e.jsx(f,{size:"sm",onClick:p,disabled:!m.trim(),className:"h-8 px-3",children:"전송"}),e.jsx(f,{variant:"ghost",size:"sm",onClick:()=>{l(!1),o("")},className:"h-6 px-2 text-xs",children:"취소"})]})]}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:[m.length,"/500자"]})]})]})}function G({items:s,onSelect:d,disabled:c=!1,className:u=""}){return s?.length?e.jsxs("div",{className:`mt-3 ${u}`,children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(I,{className:"w-3 h-3 text-amber-500"}),e.jsx("span",{className:"text-xs text-gray-500 font-medium",children:"연계 질문"})]}),e.jsx("div",{className:"flex flex-wrap gap-1.5",children:s.map((a,i)=>e.jsx(f,{variant:"outline",size:"sm",onClick:()=>d(a),disabled:c,className:"text-xs bg-white hover:bg-blue-50 border-blue-200 text-blue-700 max-w-full disabled:opacity-50 disabled:cursor-not-allowed h-6 px-2 py-1",title:c?"응답 생성 중...":"이 질문으로 이어서 묻기",children:e.jsx("span",{className:"truncate text-xs",children:a})},`${a}-${i}`))})]}):null}function H(){const s=n.useRef(null),d=n.useRef([]),c=n.useCallback(()=>{s.current={startTime:performance.now(),totalChunks:0,totalChars:0,averageChunkSize:0,streamingDuration:0,charsPerSecond:0},d.current=[]},[]),u=n.useCallback(l=>{if(!s.current)return;const m=performance.now(),o=l.length;s.current.totalChunks++,s.current.totalChars+=o,s.current.averageChunkSize=s.current.totalChars/s.current.totalChunks,s.current.firstChunkTime||(s.current.firstChunkTime=m),s.current.lastChunkTime=m,d.current.push(m)},[]),a=n.useCallback(()=>{if(!s.current)return;const l=performance.now();s.current.streamingDuration=l-s.current.startTime,s.current.streamingDuration>0&&(s.current.charsPerSecond=s.current.totalChars/s.current.streamingDuration*1e3),typeof window<"u"&&window.location.hostname==="localhost"&&console.log("📊 스트리밍 성능 메트릭:",{총_응답시간:`${(s.current.streamingDuration/1e3).toFixed(2)}초`,총_문자수:s.current.totalChars,총_청크수:s.current.totalChunks,평균_청크크기:s.current.averageChunkSize.toFixed(1),초당_문자수:s.current.charsPerSecond.toFixed(1),첫_청크_지연:s.current.firstChunkTime?`${((s.current.firstChunkTime-s.current.startTime)/1e3).toFixed(2)}초`:"N/A"}),s.current.totalChars>100},[]),i=n.useCallback(()=>s.current,[]),g=n.useCallback(()=>{s.current=null,d.current=[]},[]);return{startStreaming:c,recordChunk:u,endStreaming:a,getMetrics:i,reset:g}}function J(s){const[d,c]=n.useState([]),[u,a]=n.useState(!1),[i,g]=n.useState(),[l,m]=n.useState(()=>{if(typeof window>"u")return"cid-server";const b=localStorage.getItem("cid"),v=b??crypto.randomUUID();return b||localStorage.setItem("cid",v),v}),o=n.useRef(!1),{endStreaming:x}=H();async function p(b){if(!b.trim())return;if(o.current){console.warn("[useChat] Duplicate send attempt blocked");return}o.current=!0,a(!0);const v=crypto.randomUUID();c(r=>[...r,{role:"user",text:b,messageId:v}]);let C;const t=crypto.randomUUID();c(r=>(C=r.length,[...r,{role:"assistant",text:"",suggestions:[],messageId:t}]));try{const r=await P({userQuestion:b,major:s.major,subField:s.subField,conversationId:l,followupMode:"never",suggestCount:0});c(w=>{const j=[...w];return j[C]&&(j[C]={...j[C],text:r.aiResponse,suggestions:r.suggestions||[]}),j}),r.conversationId&&r.conversationId!==l&&(m(r.conversationId),localStorage.setItem("cid",r.conversationId)),a(!1),x()}catch(r){a(!1),g(r instanceof Error?r.message:"채팅 중 오류가 발생했습니다."),c(w=>w.filter(j=>j.messageId!==t)),x()}finally{o.current=!1}}const N=n.useCallback(()=>{a(!1),x(),o.current=!1},[x]);return n.useEffect(()=>()=>{x(),o.current=!1},[x]),n.useMemo(()=>({messages:d,loading:u,error:i,conversationId:l,send:p,cancel:N}),[d,u,i,l,p,N])}function ee(){const[,s]=R("/chat/:majorId/:subId"),[,d]=F(),c=s?.majorId,u=s?.subId,a=n.useMemo(()=>c?B(c):null,[c]),i=n.useMemo(()=>c&&u?K(c,u):null,[c,u]);n.useEffect(()=>{a&&i&&console.log("[Chat] Initialized with:",{major:a.name,subField:i.name})},[a,i]);const{messages:g,loading:l,error:m,send:o}=J({major:a?.name||"",subField:i?.name||"",suggestCount:3,conversationId:void 0}),[x,p]=n.useState(""),N=async t=>{if(t.preventDefault(),!x.trim()||l)return;const r=x.trim();p(""),await o(r)},h=async t=>{l||await o(t)},b=async t=>{l||await o(t)},v=()=>{window.location.reload()},C=()=>{const t=g.filter(r=>r.role==="user").pop();t&&o(t.text)};return!a||!i?e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 mb-4",children:"카테고리를 찾을 수 없습니다"}),e.jsx(f,{onClick:()=>d("/"),children:"홈으로 돌아가기"})]})}):e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx("div",{className:"bg-white border-b",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"flex items-center justify-between h-16",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs(f,{variant:"ghost",size:"sm",onClick:()=>d("/"),className:"flex items-center space-x-2",children:[e.jsx(E,{className:"w-4 h-4"}),e.jsx("span",{children:"카테고리로 돌아가기"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{className:"text-sm text-gray-500",children:"💻"}),e.jsx("span",{className:"font-medium",children:a.name}),e.jsx("span",{className:"text-gray-400",children:">"}),e.jsx("span",{className:"font-medium",children:i.name})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[m&&e.jsxs(f,{variant:"outline",size:"sm",onClick:C,className:"flex items-center space-x-2","data-testid":"button-retry",children:[e.jsx(L,{className:"w-4 h-4"}),e.jsx("span",{children:"재시도"})]}),e.jsxs(f,{variant:"outline",onClick:v,className:"flex items-center space-x-2","data-testid":"button-clear-chat",children:[e.jsx(U,{className:"w-4 h-4"}),e.jsx("span",{children:"대화 초기화"})]})]})]})})}),e.jsxs("div",{className:"max-w-4xl mx-auto p-4 sm:p-6 lg:p-8",children:[e.jsx(y,{className:"mb-6 bg-blue-50 border-blue-200",children:e.jsxs(k,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(I,{className:"w-5 h-5 text-blue-600"}),e.jsxs("h2",{className:"text-lg font-semibold text-blue-800",children:[a.name," - ",i.name," 카테고리를 선택했습니다"]})]}),e.jsx("p",{className:"text-blue-700",children:"AI 튜터와 함께 학습하세요. 궁금한 것을 자유롭게 질문해보세요!"})]})}),e.jsx(y,{className:"mb-6 bg-amber-50 border-amber-200",children:e.jsxs(k,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-3",children:[e.jsx(I,{className:"w-5 h-5 text-amber-600"}),e.jsx("h3",{className:"font-semibold text-amber-800",children:"질문 예시"})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:i.sampleQuestions?.map((t,r)=>e.jsx(f,{variant:"outline",size:"sm",onClick:()=>b(t),className:"text-xs bg-white hover:bg-amber-100 border-amber-300 text-amber-700","data-testid":`button-sample-${r}`,disabled:l,children:t},r))||e.jsx("p",{className:"text-sm text-gray-500",children:"예시 질문이 없습니다"})})]})}),e.jsx(y,{className:"mb-6 bg-white",children:e.jsx(k,{className:"p-0",children:e.jsxs("div",{className:"h-96 overflow-y-auto p-4 space-y-4","data-testid":"chat-messages",children:[g.map((t,r)=>e.jsx("div",{className:`flex ${t.role==="user"?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-xs lg:max-w-md ${t.role==="user"?"bg-primary text-white":"bg-gray-100 text-gray-800"} px-4 py-2 rounded-lg shadow-sm`,"data-testid":`message-${t.role}-${r}`,children:[e.jsx("p",{className:"whitespace-pre-wrap",children:t.text}),t.role==="assistant"&&t.suggestions&&t.suggestions.length>0&&e.jsx(G,{items:t.suggestions,onSelect:h,disabled:l,className:"mt-3"}),t.role==="assistant"&&e.jsx("div",{className:"mt-2",children:e.jsx(Q,{messageId:t.messageId,onFeedback:(w,j)=>{console.log("Feedback:",w,j)}})})]})},t.messageId)),l&&e.jsx("div",{className:"flex justify-start",children:e.jsx("div",{className:"bg-gray-100 text-gray-800 px-4 py-2 rounded-lg shadow-sm max-w-xs lg:max-w-md",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(S,{className:"w-4 h-4 animate-spin"}),e.jsx("span",{className:"text-sm",children:"AI가 답변을 생성하고 있습니다..."})]})})}),m&&e.jsx("div",{className:"flex justify-center",children:e.jsxs("div",{className:"bg-red-50 text-red-700 px-4 py-2 rounded-lg flex items-center space-x-2",children:[e.jsx(_,{className:"w-4 h-4"}),e.jsx("span",{children:m})]})})]})})}),e.jsx(y,{className:"bg-white",children:e.jsxs(k,{className:"p-4",children:[e.jsxs("form",{onSubmit:N,className:"flex space-x-2",children:[e.jsx(M,{value:x,onChange:t=>p(t.target.value),placeholder:"궁금한 것을 질문해보세요...",className:"flex-1",disabled:l,"data-testid":"input-message"}),e.jsx(f,{type:"submit",disabled:!x.trim()||l,className:"bg-primary text-white","data-testid":"button-send",children:l?e.jsx(S,{className:"w-4 h-4 animate-spin"}):e.jsx(A,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"mt-2 text-xs text-gray-500 space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Enter를 눌러 전송 • Shift+Enter로 줄바꿈"}),e.jsx("span",{className:"text-gray-400",children:"Ctrl+K: 입력창 포커스"})]}),e.jsx("div",{className:"text-gray-400",children:"Ctrl+Enter: 빠른 전송 • Ctrl+L: 대화 초기화"})]})]})})]})]})}export{ee as default};
