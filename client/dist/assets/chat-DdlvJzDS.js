import{c as b,r as n,j as e,f as Z,k as A,i as Q,h as G,l as J,m as O}from"./index-3IAe9-t_.js";import{B as u}from"./button-Dft3dBGT.js";import{C,c as M}from"./card-BjUH1LOu.js";import{g as W,a as X,A as Y}from"./categories-Bz0JUY6a.js";import{a as _}from"./api-DHzPUgmj.js";import{C as ee}from"./circle-alert-jMfk-Biz.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const se=b("Lightbulb",[["path",{d:"M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5",key:"1gvzjb"}],["path",{d:"M9 18h6",key:"x1upvd"}],["path",{d:"M10 22h4",key:"ceow96"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const te=b("RotateCcw",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ae=b("Send",[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ne=b("ThumbsDown",[["path",{d:"M17 14V2",key:"8ymqnk"}],["path",{d:"M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22a3.13 3.13 0 0 1-3-3.88Z",key:"m61m77"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ie=b("ThumbsUp",[["path",{d:"M7 10v12",key:"1qc93n"}],["path",{d:"M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2a3.13 3.13 0 0 1 3 3.88Z",key:"emmmcr"}]]),K=n.forwardRef(({className:t,type:c,...r},l)=>e.jsx("input",{type:c,className:Z("flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",t),ref:l,...r}));K.displayName="Input";function re({messageId:t,onFeedbackSubmitted:c}){const[r,l]=n.useState(null),[d,j]=n.useState(!1),{toast:g}=A(),y=async h=>{if(!(r||d)){j(!0);try{await _.sendFeedback({messageId:t,feedback:h}),l(h),c==null||c(h),g({title:"피드백 감사합니다!",description:h==="like"?"도움이 되었다니 기쁩니다.":"더 나은 답변을 위해 노력하겠습니다."})}catch{g({title:"피드백 전송 실패",description:"잠시 후 다시 시도해주세요.",variant:"destructive"})}finally{j(!1)}}};return e.jsxs("div",{className:"flex items-center space-x-2 mt-2",children:[e.jsx(u,{variant:"ghost",size:"sm",onClick:()=>y("like"),disabled:r!==null||d,className:`h-6 px-2 ${r==="like"?"text-green-600 bg-green-50":"text-gray-400 hover:text-green-600"}`,"data-testid":`feedback-like-${t}`,children:e.jsx(ie,{className:"w-3 h-3"})}),e.jsx(u,{variant:"ghost",size:"sm",onClick:()=>y("dislike"),disabled:r!==null||d,className:`h-6 px-2 ${r==="dislike"?"text-red-600 bg-red-50":"text-gray-400 hover:text-red-600"}`,"data-testid":`feedback-dislike-${t}`,children:e.jsx(ne,{className:"w-3 h-3"})})]})}function le({items:t,onSelect:c}){const r=Array.isArray(t)?t:[];return r.length?e.jsx("div",{className:"flex flex-wrap gap-2 mt-3",children:r.map((l,d)=>e.jsx("button",{onClick:()=>c(l),className:"px-3 py-1 rounded-full border text-sm hover:bg-gray-50",children:l},`${l}-${d}`))}):null}function he(){const[,t]=Q("/chat/:majorId/:subId"),[,c]=G(),{toast:r}=A();n.useEffect(()=>{J().catch(s=>{console.error("❌ Backend validation failed:",s),r({title:"백엔드 연결 오류",description:s.message||"백엔드 서버에 연결할 수 없습니다.",variant:"destructive"})})},[r]);const[l,d]=n.useState([]),[j,g]=n.useState(null),[y,h]=n.useState([]),[f,p]=n.useState(""),[o,$]=n.useState(!1),[N,w]=n.useState(null),[T,S]=n.useState(0),k=["AI가 답변을 생성하고 있어요...","최적의 답변을 찾고 있어요...","곧 완료됩니다..."];n.useEffect(()=>{if(!o){S(0);return}const s=setInterval(()=>{S(a=>(a+1)%k.length)},2e3);return()=>clearInterval(s)},[o,k.length]);const L=n.useRef(null),R=s=>{D(s)},m=n.useMemo(()=>t!=null&&t.majorId?W(t.majorId):null,[t==null?void 0:t.majorId]),x=n.useMemo(()=>t!=null&&t.majorId&&(t!=null&&t.subId)?X(t.majorId,t.subId):null,[t==null?void 0:t.majorId,t==null?void 0:t.subId]);n.useEffect(()=>{if(t!=null&&t.majorId&&(t!=null&&t.subId)&&m&&x){const s={id:`system-${Date.now()}`,content:`${m.name} - ${x.name} 카테고리를 선택했습니다. 궁금한 것을 자유롭게 질문해보세요!`,sender:"system",timestamp:new Date};setChatState(a=>({...a,messages:[s],error:null,lastAIMessageId:null}))}},[t==null?void 0:t.majorId,t==null?void 0:t.subId,m,x]),n.useEffect(()=>{B()},[l]);const B=()=>{var s;(s=L.current)==null||s.scrollIntoView({behavior:"smooth"})};async function D(s){if(!s.trim()||o||!(t!=null&&t.majorId)||!(t!=null&&t.subId))return;$(!0),w(null),h([]);const a={id:`user-${Date.now()}`,content:s,sender:"user",timestamp:new Date};d(i=>[...i,a]);try{const i=await O({userQuestion:s,major:t.majorId,subField:t.subId,conversationId:j??void 0,followupMode:"single",suggestCount:3});g(i.conversationId);const v={id:`ai-${Date.now()}`,content:String(i.aiResponse??""),sender:"ai",timestamp:new Date,suggestions:i.suggestions};d(V=>[...V,v]),Array.isArray(i.suggestions)&&i.suggestions.length&&h(i.suggestions)}catch(i){const v=`[API] 요청 실패: ${(i==null?void 0:i.message)??String(i)}`;w(v),r({title:"메시지 전송 실패",description:v,variant:"destructive"})}finally{$(!1)}}const I=async s=>{const a=f.trim();p(""),await D(a)},E=()=>{if(m&&x){const s={id:`system-${Date.now()}`,content:`${m.name} - ${x.name} 카테고리를 선택했습니다. 궁금한 것을 자유롭게 질문해보세요!`,sender:"system",timestamp:new Date};d([s]),g(null),h([]),w(null)}},z=()=>{const s=[...l].reverse().find(a=>a.sender==="user");s&&p(s.content)},P=s=>{p(s)},q=s=>{s.sender==="ai"&&m&&x&&r({title:"북마크 기능",description:"곧 구현될 예정입니다.",variant:"default"})},F=()=>{c(`/categories/${t==null?void 0:t.majorId}`)},H=s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),I())};n.useEffect(()=>{const s=a=>{if((a.ctrlKey||a.metaKey)&&a.key==="Enter"&&(a.preventDefault(),f.trim()&&!o&&I()),(a.ctrlKey||a.metaKey)&&a.key==="k"){a.preventDefault();const i=document.querySelector('[data-testid="input-message"]');i==null||i.focus()}(a.ctrlKey||a.metaKey)&&a.key==="l"&&(a.preventDefault(),E())};return document.addEventListener("keydown",s),()=>document.removeEventListener("keydown",s)},[f,o]);const U=s=>s?s<1e3?`${s}ms`:`${(s/1e3).toFixed(1)}s`:"";return!m||!x?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-cyan-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h1",{className:"text-2xl font-bold text-text-primary mb-4",children:"잘못된 접근입니다"}),e.jsx(u,{onClick:()=>c("/"),"data-testid":"button-go-home",children:"홈으로 돌아가기"})]})}):e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-cyan-50",children:e.jsxs("div",{className:"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[e.jsxs("div",{className:"mb-6",children:[e.jsxs(u,{variant:"ghost",onClick:F,className:"mb-4","data-testid":"button-back-categories",children:[e.jsx(Y,{className:"w-4 h-4 mr-2"}),"카테고리로 돌아가기"]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"text-3xl",children:m.emoji}),e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold text-text-primary",children:[m.name," ",">"," ",x.name]}),e.jsx("p",{className:"text-gray-600",children:"AI 튜터와 함께 학습하세요"})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[N&&e.jsxs(u,{variant:"outline",size:"sm",onClick:z,className:"flex items-center space-x-2","data-testid":"button-retry",children:[e.jsx(RefreshCw,{className:"w-4 h-4"}),e.jsx("span",{children:"재시도"})]}),e.jsxs(u,{variant:"outline",onClick:E,className:"flex items-center space-x-2","data-testid":"button-clear-chat",children:[e.jsx(te,{className:"w-4 h-4"}),e.jsx("span",{children:"대화 초기화"})]})]})]})]}),e.jsx(C,{className:"mb-6 bg-amber-50 border-amber-200",children:e.jsxs(M,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-3",children:[e.jsx(se,{className:"w-5 h-5 text-amber-600"}),e.jsx("h3",{className:"font-semibold text-amber-800",children:"질문 예시"})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:x.sampleQuestions.map((s,a)=>e.jsx(u,{variant:"outline",size:"sm",onClick:()=>P(s),className:"text-xs bg-white hover:bg-amber-100 border-amber-300 text-amber-700","data-testid":`button-sample-${a}`,disabled:!1,children:s},a))})]})}),e.jsx(C,{className:"mb-6 bg-white",children:e.jsx(M,{className:"p-0",children:e.jsxs("div",{className:"h-96 overflow-y-auto p-4 space-y-4","data-testid":"chat-messages",children:[l.map(s=>e.jsx("div",{className:`flex ${s.sender==="user"?"justify-end":s.sender==="system"?"justify-center":"justify-start"}`,children:e.jsxs("div",{className:`max-w-xs lg:max-w-md ${s.sender==="user"?"bg-primary text-white":s.sender==="system"?"bg-amber-100 text-amber-800 text-sm":"bg-gray-100 text-gray-800"} px-4 py-2 rounded-lg shadow-sm`,"data-testid":`message-${s.sender}-${s.id}`,children:[e.jsx("p",{className:"whitespace-pre-wrap",children:s.content}),e.jsx("div",{className:"flex items-center justify-between mt-1",children:e.jsxs("p",{className:`text-xs ${s.sender==="user"?"text-blue-100":s.sender==="system"?"text-amber-600":"text-gray-500"}`,children:[s.timestamp.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),s.processingTime&&e.jsxs("span",{className:"ml-2",children:["(",U(s.processingTime),")"]})]})}),s.sender==="ai"&&e.jsx("div",{className:"mt-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(re,{messageId:s.id}),e.jsx(u,{variant:"ghost",size:"sm",onClick:()=>q(s),className:"text-yellow-600 hover:text-yellow-800","data-testid":`bookmark-${s.id}`,children:e.jsx(Star,{className:"w-3 h-3"})})]})})]})},s.id)),o&&e.jsx("div",{className:"flex justify-start",children:e.jsx("div",{className:"bg-blue-50 text-blue-800 px-4 py-3 rounded-lg shadow-sm max-w-xs lg:max-w-md",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("div",{className:"flex space-x-1",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full animate-bounce"}),e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full animate-bounce",style:{animationDelay:"0.1s"}}),e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full animate-bounce",style:{animationDelay:"0.2s"}})]}),e.jsx("span",{className:"text-sm",children:k[T]})]})})}),N&&e.jsx("div",{className:"flex justify-center",children:e.jsxs("div",{className:"bg-red-50 text-red-700 px-4 py-2 rounded-lg flex items-center space-x-2",children:[e.jsx(ee,{className:"w-4 h-4"}),e.jsx("span",{children:N})]})}),e.jsx(le,{items:y,onSelect:R}),e.jsx("div",{ref:L})]})})}),e.jsx(C,{className:"bg-white",children:e.jsxs(M,{className:"p-4",children:[e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(K,{value:f,onChange:s=>p(s.target.value),onKeyPress:H,placeholder:"궁금한 것을 질문해보세요...",className:"flex-1",disabled:o,"data-testid":"input-message"}),e.jsx(u,{onClick:()=>I(),disabled:!f.trim()||o,className:"bg-primary text-white","data-testid":"button-send",children:o?e.jsx(Loader2,{className:"w-4 h-4 animate-spin"}):e.jsx(ae,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"mt-2 text-xs text-gray-500 space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Enter를 눌러 전송 • Shift+Enter로 줄바꿈"}),e.jsx("span",{className:"text-gray-400",children:"Ctrl+K: 입력창 포커스"})]}),e.jsx("div",{className:"text-gray-400",children:"Ctrl+Enter: 빠른 전송 • Ctrl+L: 대화 초기화"})]})]})})]})})}export{he as default};
