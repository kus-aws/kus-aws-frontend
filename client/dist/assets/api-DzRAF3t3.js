const r="https://h2yvhophi3.execute-api.us-east-1.amazonaws.com".replace(/\/$/,"");class c extends Error{constructor(t,s,a){super(t),this.status=s,this.details=a,this.name="ApiError"}}function u(){if(!r)throw new Error("백엔드 주소 미설정: .env(또는 Vercel env)의 VITE_BACKEND_BASE를 확인하세요.")}console.log("[API] Using backend URL:",r);function l(){try{return crypto.randomUUID()}catch{return`trace-${Date.now()}`}}function p(e){return Array.isArray(e)?e.filter(t=>typeof t=="string"&&t.trim()).slice(0,5):[]}function g(e){return e?.detail?.error==="bedrock_timeout"}async function f(){u();const e=await fetch(`${r}/health`,{method:"GET",credentials:"omit"});try{return await e.json()}catch{return"ok"}}function h(e){return e&&typeof e.aiResponse=="string"&&typeof e.conversationId=="string"}function d(e){return e&&Array.isArray(e.suggestions)}async function w(e){u();const t=l();try{console.log(`[chat:${t}] Request payload:`,e),console.log(`[chat:${t}] API Gateway URL:`,`${r}/chat`);const s=await fetch(`${r}/chat`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","x-client-request-id":t},body:JSON.stringify({userQuestion:e.userQuestion,major:e.major,subField:e.subField,conversationId:e.conversationId,followupMode:e.followupMode||"never",suggestCount:e.suggestCount||0}),credentials:"omit"}),a=s.headers.get("content-type")||"",n=await s.text();let o=null;try{a.includes("application/json")&&(o=JSON.parse(n))}catch(i){console.warn(`[chat:${t}] JSON parse failed:`,i)}if(s.status===504)throw console.error(`[chat:${t}] 504 Gateway Timeout - Request payload:`,e),console.error(`[chat:${t}] Response:`,n),o&&g(o)?new c("지금 답변 생성이 지연되고 있어요. 잠시 후 다시 시도해 주세요.",504,o):new c("서버 응답 시간이 초과되었습니다. 잠시 후 다시 시도해 주세요.",504,{raw:n});if(!s.ok)throw console.error(`[chat:${t}] HTTP ${s.status} - Request payload:`,e),console.error(`[chat:${t}] Response:`,n),new c(`HTTP ${s.status}: ${n||"Internal Server Error"}`,s.status,{raw:n,payload:e});if(!o)throw new Error("서버 응답을 파싱할 수 없습니다.");return h(o)?(console.log(`[chat:${t}] Response:`,o),o):(console.warn(`[chat:${t}] invalid response shape:`,o),{aiResponse:"죄송합니다. 일시적인 오류가 발생했습니다.",conversationId:e.conversationId??"unknown",suggestions:[]})}catch(s){throw console.error(`[chat:${t}] Request failed:`,s),s}}async function $(e){u();const t=l();try{console.log(`[suggestions:${t}] Request payload:`,e),console.log(`[suggestions:${t}] API Gateway URL:`,`${r}/suggestions`);const s=await fetch(`${r}/suggestions`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","x-client-request-id":t},body:JSON.stringify(e),credentials:"omit"}),a=s.headers.get("content-type")||"",n=await s.text();let o=null;try{a.includes("application/json")&&(o=JSON.parse(n))}catch(i){console.warn(`[suggestions:${t}] JSON parse failed:`,i)}return s.ok?o?d(o)?(console.log(`[suggestions:${t}] Response:`,o),p(o.suggestions)):(console.warn(`[suggestions:${t}] invalid response shape:`,o),[]):(console.warn(`[suggestions:${t}] No data received`),[]):(console.error(`[suggestions:${t}] HTTP ${s.status} - Request payload:`,e),console.error(`[suggestions:${t}] Response:`,n),[])}catch(s){return console.error(`[suggestions:${t}] Request failed:`,s),[]}}export{c as A,w as c,$ as f,f as h};
