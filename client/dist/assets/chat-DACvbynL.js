import{j as e,c as $,a as A,u as O}from"./index-D3IBV46F.js";import{r as n}from"./vendor-CwHBbTcV.js";import{B as b}from"./button-BdomRkx-.js";import{C as F,a as z}from"./card-D67bOADn.js";import{T as _,d as P,e as R,f as q,A as B,R as K,L as D,C as Q,g as J,h as G,i as H,j as V}from"./lucide-CoysGt0P.js";import{f as T,c as W,A as X}from"./api-DzRAF3t3.js";import{g as Y,a as Z}from"./categories-BlY_H3dN.js";const U=n.forwardRef(({className:s,type:o,...l},i)=>e.jsx("input",{type:o,className:$("flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",s),ref:i,...l}));U.displayName="Input";function ee({messageId:s,onFeedback:o,onComment:l,className:i=""}){const[c,g]=n.useState(null),[p,a]=n.useState(!1),[d,f]=n.useState(""),w=j=>{g(j),o?.(j,s),j==="positive"&&setTimeout(()=>g(null),2e3)},y=()=>{d.trim()&&(l?.(d.trim(),s),f(""),a(!1))},I=j=>{j.key==="Enter"&&!j.shiftKey&&(j.preventDefault(),y())};return e.jsxs("div",{className:`flex items-center space-x-2 mt-2 ${i}`,children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(b,{variant:"ghost",size:"sm",onClick:()=>w("positive"),className:`h-8 px-2 ${c==="positive"?"bg-green-100 text-green-700 hover:bg-green-200":"hover:bg-gray-100"}`,"aria-label":"긍정적 피드백","aria-pressed":c==="positive",children:e.jsx(_,{className:"w-4 h-4"})}),e.jsx(b,{variant:"ghost",size:"sm",onClick:()=>w("negative"),className:`h-8 px-2 ${c==="negative"?"bg-red-100 text-red-700 hover:bg-red-200":"hover:bg-gray-100"}`,"aria-label":"부정적 피드백","aria-pressed":c==="negative",children:e.jsx(P,{className:"w-4 h-4"})})]}),e.jsx(b,{variant:"ghost",size:"sm",onClick:()=>a(!p),className:"h-8 px-2 hover:bg-gray-100","aria-label":"코멘트 추가","aria-expanded":p,children:e.jsx(R,{className:"w-4 h-4"})}),c&&e.jsx("span",{className:"text-sm text-gray-600 ml-2",children:c==="positive"?"👍 도움이 되었습니다":"👎 개선이 필요합니다"}),p&&e.jsxs("div",{className:"flex-1 ml-2",children:[e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("textarea",{value:d,onChange:j=>f(j.target.value),onKeyPress:I,placeholder:"의견을 입력해주세요...",className:"flex-1 px-3 py-2 border border-gray-300 rounded-md text-sm resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent",rows:2,maxLength:500}),e.jsxs("div",{className:"flex flex-col space-y-1",children:[e.jsx(b,{size:"sm",onClick:y,disabled:!d.trim(),className:"h-8 px-3",children:"전송"}),e.jsx(b,{variant:"ghost",size:"sm",onClick:()=>{a(!1),f("")},className:"h-6 px-2 text-xs",children:"취소"})]})]}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:[d.length,"/500자"]})]})]})}function se({suggestions:s,onSuggestionClick:o,disabled:l=!1}){return s?.length?e.jsxs("div",{className:"mt-4 pt-3 border-t border-gray-100",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(q,{className:"w-3.5 h-3.5 text-blue-500"}),e.jsx("span",{className:"text-xs font-medium text-gray-600",children:"이어서 물어보기"})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:s.slice(0,5).map((i,c)=>e.jsx(b,{variant:"ghost",size:"sm",onClick:()=>o(i),disabled:l,className:`
              h-auto min-h-[32px] px-3 py-2 text-xs
              bg-blue-50 hover:bg-blue-100 
              text-blue-700 hover:text-blue-800
              border border-blue-200 hover:border-blue-300
              rounded-full transition-all duration-200
              disabled:opacity-50 disabled:cursor-not-allowed
              max-w-[280px] text-left justify-start
              shadow-sm hover:shadow-md
            `,title:i.length>35?i:void 0,children:e.jsx("span",{className:"truncate leading-relaxed",children:i.length>35?`${i.slice(0,35)}...`:i})},`msg-suggestion-${c}`))}),s.length>5&&e.jsxs("p",{className:"text-xs text-gray-400 mt-2",children:["+",s.length-5,"개 더 있음"]})]}):null}function te(){const s=n.useRef(null),o=n.useRef([]),l=n.useCallback(()=>{s.current={startTime:performance.now(),totalChunks:0,totalChars:0,averageChunkSize:0,streamingDuration:0,charsPerSecond:0},o.current=[]},[]),i=n.useCallback(a=>{if(!s.current)return;const d=performance.now(),f=a.length;s.current.totalChunks++,s.current.totalChars+=f,s.current.averageChunkSize=s.current.totalChars/s.current.totalChunks,s.current.firstChunkTime||(s.current.firstChunkTime=d),s.current.lastChunkTime=d,o.current.push(d)},[]),c=n.useCallback(()=>{if(!s.current)return;const a=performance.now();s.current.streamingDuration=a-s.current.startTime,s.current.streamingDuration>0&&(s.current.charsPerSecond=s.current.totalChars/s.current.streamingDuration*1e3),typeof window<"u"&&window.location.hostname==="localhost"&&console.log("📊 스트리밍 성능 메트릭:",{총_응답시간:`${(s.current.streamingDuration/1e3).toFixed(2)}초`,총_문자수:s.current.totalChars,총_청크수:s.current.totalChunks,평균_청크크기:s.current.averageChunkSize.toFixed(1),초당_문자수:s.current.charsPerSecond.toFixed(1),첫_청크_지연:s.current.firstChunkTime?`${((s.current.firstChunkTime-s.current.startTime)/1e3).toFixed(2)}초`:"N/A"}),s.current.totalChars>100},[]),g=n.useCallback(()=>s.current,[]),p=n.useCallback(()=>{s.current=null,o.current=[]},[]);return{startStreaming:l,recordChunk:i,endStreaming:c,getMetrics:g,reset:p}}function ae(s){const[o,l]=n.useState([]),[i,c]=n.useState(!1),[g,p]=n.useState(),[a,d]=n.useState(()=>{if(typeof window>"u")return"cid-server";const u=localStorage.getItem("cid"),m=u??crypto.randomUUID();return u||localStorage.setItem("cid",m),m}),f=n.useRef(!1),{endStreaming:w}=te();async function y(u){if(!u.trim())return;if(f.current){console.warn("[useChat] Duplicate send attempt blocked");return}f.current=!0,c(!0),p(void 0);const m=crypto.randomUUID();l(r=>[...r,{role:"user",text:u,messageId:m}]);let x;const N=crypto.randomUUID();l(r=>(x=r.length,[...r,{role:"assistant",text:"",suggestions:[],messageId:N}]));try{const r=await W({userQuestion:u,major:s.major,subField:s.subField,conversationId:a,followupMode:"never",suggestCount:0});l(h=>{const v=[...h];return v[x]&&(v[x]={...v[x],text:r.aiResponse,suggestions:[]}),v}),r.conversationId&&r.conversationId!==a&&(d(r.conversationId),localStorage.setItem("cid",r.conversationId)),s.suggestCount&&s.suggestCount>0&&(console.log("[useChat] Fetching suggestions separately..."),T({conversationId:r.conversationId,major:s.major,subField:s.subField,suggestCount:s.suggestCount}).then(h=>{console.log("[useChat] Suggestions received:",h),l(v=>{const C=[...v];return C[x]&&(C[x]={...C[x],suggestions:h}),C})}).catch(h=>{console.warn("[useChat] Failed to fetch suggestions:",h)}))}catch(r){console.error("[useChat] Chat request failed:",r);let h="일시적인 오류가 발생했습니다.",v=!1;r instanceof X?r.status===504?(h="지금 답변 생성이 지연되고 있어요. 잠시 후 다시 시도해 주세요.",v=!0):h=r.message:r instanceof Error&&(h=r.message),p(h),l(C=>{const t=[...C];return t[x]&&(t[x]={...t[x],text:h,suggestions:[]}),t}),v&&console.log("[useChat] Timeout error detected, will retry automatically")}finally{c(!1),f.current=!1,w()}}const I=n.useCallback(async()=>{const u=o.filter(m=>m.role==="user").pop();u&&!i&&(console.log("[useChat] Retrying last message due to timeout"),await y(u.text))},[o,i]),j=n.useCallback(()=>{const u=o.filter(m=>m.role==="user").pop();if(u){const m={question:u.text,timestamp:new Date().toISOString(),major:s.major,subField:s.subField},x=JSON.parse(localStorage.getItem("offline_questions")||"[]");x.push(m),localStorage.setItem("offline_questions",JSON.stringify(x)),console.log("[useChat] Question saved offline:",m)}},[o,s.major,s.subField]),k=n.useCallback(async()=>{if(o.filter(m=>m.role==="user").pop()&&!i){console.log("[useChat] Fetching suggestions only");try{const m=await T({conversationId:a,major:s.major,subField:s.subField,suggestCount:s.suggestCount||3});l(x=>{const N=[...x],r=N.findIndex(h=>h.role==="assistant");return r!==-1&&(N[r]={...N[r],suggestions:m}),N}),p(void 0)}catch(m){console.error("[useChat] Failed to fetch suggestions only:",m),p("제안 질문을 가져올 수 없습니다.")}}},[o,i,a,s.major,s.subField,s.suggestCount]),M=n.useCallback(()=>{l([]),p(void 0),c(!1),f.current=!1;const u=crypto.randomUUID();d(u),localStorage.setItem("cid",u)},[]);return{messages:o,loading:i,error:g,send:y,retryLastMessage:I,saveOffline:j,showSuggestionsOnly:k,clearChat:M,conversationId:a}}function me(){const[,s]=A("/chat/:majorId/:subId"),[,o]=O(),l=s?.majorId,i=s?.subId,c=n.useMemo(()=>l?Y(l):null,[l]),g=n.useMemo(()=>l&&i?Z(l,i):null,[l,i]);n.useEffect(()=>{c&&g&&console.log("[Chat] Initialized with:",{major:c.name,subField:g.name})},[c,g]);const{messages:p,loading:a,error:d,send:f,retryLastMessage:w,saveOffline:y,showSuggestionsOnly:I,clearChat:j}=ae({major:c?.name||"",subField:g?.name||"",suggestCount:3,conversationId:void 0}),[k,M]=n.useState(""),u=async t=>{if(t.preventDefault(),!k.trim()||a)return;const S=k.trim();M(""),await f(S)},m=async t=>{a||await f(t)},x=async t=>{a||await f(t)},N=()=>{j()},r=()=>{w()},h=()=>{y()},v=()=>{I()},C=d&&(d.includes("지연되고 있어요")||d.includes("응답 시간이 초과")||d.includes("잠시 후 다시 시도"));return!c||!g?e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 mb-4",children:"카테고리를 찾을 수 없습니다"}),e.jsx(b,{onClick:()=>o("/"),children:"홈으로 돌아가기"})]})}):e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx("div",{className:"bg-white border-b",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"flex items-center justify-between h-16",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs(b,{variant:"ghost",size:"sm",onClick:()=>o("/"),className:"flex items-center space-x-2",children:[e.jsx(B,{className:"w-4 h-4"}),e.jsx("span",{children:"카테고리로 돌아가기"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{className:"text-sm text-gray-500",children:"💻"}),e.jsx("span",{className:"font-medium",children:c.name}),e.jsx("span",{className:"text-gray-400",children:">"}),e.jsx("span",{className:"font-medium",children:g.name})]})]}),e.jsx("div",{className:"flex items-center space-x-2",children:e.jsxs(b,{variant:"outline",onClick:N,className:"flex items-center space-x-2","data-testid":"button-clear-chat",children:[e.jsx(K,{className:"w-4 h-4"}),e.jsx("span",{children:"대화 초기화"})]})})]})})}),e.jsxs("div",{className:"max-w-4xl mx-auto p-4 sm:p-6 lg:p-8",children:[e.jsx(F,{className:"mb-6 bg-blue-50 border-blue-200",children:e.jsxs(z,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(D,{className:"w-5 h-5 text-blue-600"}),e.jsxs("h2",{className:"text-lg font-semibold text-blue-800",children:[c.name," - ",g.name," 카테고리를 선택했습니다"]})]}),e.jsx("p",{className:"text-blue-700",children:"AI 튜터와 함께 학습하세요. 궁금한 것을 자유롭게 질문해보세요!"})]})}),e.jsx(F,{className:"mb-6 bg-amber-50 border-amber-200",children:e.jsxs(z,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-3",children:[e.jsx(D,{className:"w-5 h-5 text-amber-600"}),e.jsx("h3",{className:"font-semibold text-amber-800",children:"질문 예시"})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:g.sampleQuestions?.map((t,S)=>e.jsx(b,{variant:"outline",size:"sm",onClick:()=>x(t),className:"text-xs bg-white hover:bg-amber-100 border-amber-300 text-amber-700","data-testid":`button-sample-${S}`,disabled:a,children:t},S))||e.jsx("p",{className:"text-sm text-gray-500",children:"예시 질문이 없습니다"})})]})}),e.jsx(F,{className:"mb-6 bg-white",children:e.jsx(z,{className:"p-0",children:e.jsxs("div",{className:"h-96 overflow-y-auto p-4 space-y-4","data-testid":"chat-messages",children:[p.filter(t=>t.role==="user"||t.role==="assistant"&&(t.text.trim()||!a)).map((t,S)=>e.jsx("div",{className:`flex ${t.role==="user"?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-xs lg:max-w-md ${t.role==="user"?"bg-primary text-white":"bg-gray-100 text-gray-800"} px-4 py-2 rounded-lg shadow-sm`,"data-testid":`message-${t.role}-${S}`,children:[e.jsx("p",{className:"whitespace-pre-wrap",children:t.text}),t.role==="assistant"&&t.suggestions&&t.suggestions.length>0&&e.jsx(se,{suggestions:t.suggestions,onSuggestionClick:m,disabled:a}),t.role==="assistant"&&t.text.trim()&&!a&&e.jsx("div",{className:"mt-2",children:e.jsx(ee,{messageId:t.messageId,onFeedback:(E,L)=>{console.log("Feedback:",E,L)}})})]})},t.messageId)),a&&e.jsx("div",{className:"flex justify-start",children:e.jsx("div",{className:"bg-gray-100 text-gray-800 px-4 py-3 rounded-lg shadow-sm max-w-xs lg:max-w-md",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsxs("div",{className:"flex space-x-1",children:[e.jsx("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce"}),e.jsx("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"0.1s"}}),e.jsx("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"0.2s"}})]}),e.jsx("span",{className:"text-sm text-gray-600",children:"AI가 답변을 생성하고 있습니다..."})]})})}),d&&e.jsx("div",{className:"flex justify-center",children:e.jsxs("div",{className:"bg-red-50 text-red-700 px-4 py-3 rounded-lg max-w-md",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-3",children:[e.jsx(Q,{className:"w-5 h-5"}),e.jsx("span",{className:"font-medium",children:"오류가 발생했습니다"})]}),e.jsx("p",{className:"text-sm mb-3",children:d}),C&&e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(b,{variant:"outline",size:"sm",onClick:r,className:"flex items-center space-x-2 text-red-700 border-red-300 hover:bg-red-50","data-testid":"button-retry",children:[e.jsx(J,{className:"w-4 h-4"}),e.jsx("span",{children:"다시 시도"})]}),e.jsxs(b,{variant:"outline",size:"sm",onClick:h,className:"flex items-center space-x-2 text-blue-700 border-blue-300 hover:bg-blue-50","data-testid":"button-save-offline",children:[e.jsx(G,{className:"w-4 h-4"}),e.jsx("span",{children:"오프라인 저장"})]}),e.jsxs(b,{variant:"outline",size:"sm",onClick:v,className:"flex items-center space-x-2 text-green-700 border-green-300 hover:bg-green-50","data-testid":"button-suggestions-only",children:[e.jsx(R,{className:"w-4 h-4"}),e.jsx("span",{children:"제안만 보기"})]})]})]})})]})})}),e.jsx(F,{className:"bg-white",children:e.jsxs(z,{className:"p-4",children:[e.jsxs("form",{onSubmit:u,className:"flex space-x-2",children:[e.jsx(U,{value:k,onChange:t=>M(t.target.value),placeholder:"궁금한 것을 질문해보세요...",className:"flex-1",disabled:a,"data-testid":"input-message"}),e.jsx(b,{type:"submit",disabled:!k.trim()||a,className:"bg-primary text-white","data-testid":"button-send",children:a?e.jsx(H,{className:"w-4 h-4 animate-spin"}):e.jsx(V,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"mt-2 text-xs text-gray-500 space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Enter를 눌러 전송 • Shift+Enter로 줄바꿈"}),e.jsx("span",{className:"text-gray-400",children:"Ctrl+K: 입력창 포커스"})]}),e.jsx("div",{className:"text-gray-400",children:"Ctrl+Enter: 빠른 전송 • Ctrl+L: 대화 초기화"})]})]})})]})]})}export{me as default};
