const r="".replace(/\/$/,"");r||console.warn("NEXT_PUBLIC_BACKEND_BASE not set");class y extends Error{constructor(t,n,o){super(t),this.status=n,this.details=o,this.name="ApiError"}}async function u(e,t={}){const n=`${r}${e.startsWith("/")?"":"/"}${e}`,{method:o="GET",body:c,signal:i}=t,a={"Content-Type":"application/json"};try{const s=await fetch(n,{method:o,headers:a,body:c?JSON.stringify(c):void 0,credentials:"omit",signal:i});if(!s.ok){let l;try{l=await s.json()}catch{}throw new Error(`[API] ${o} ${e} failed: ${s.status} ${s.statusText}`+(l?` :: ${JSON.stringify(l)}`:""))}return(s.headers.get("content-type")||"").includes("application/json")?await s.json():await s.text()}catch(s){throw(s==null?void 0:s.name)==="AbortError"?new Error("[API] Request aborted"):new Error(`[API] Network/CORS error on ${o} ${e}: ${(s==null?void 0:s.message)||s}`)}}const d={health:()=>u("/health"),chat:e=>u("/chat",{method:"POST",body:e}),faq:e=>u(`/faq?subField=${encodeURIComponent(e)}`)};class h{constructor(){this.baseUrl=r,this.retryAttempts=3,this.retryDelay=1e3}async makeRequest(t,n={}){return u(t,n)}shouldRetry(t){return(t==null?void 0:t.name)==="NetworkError"||(t==null?void 0:t.name)==="TimeoutError"}delay(t){return new Promise(n=>setTimeout(n,t))}async checkHealth(){return d.health()}async getSubjects(){return[]}async sendChatMessage(t){const n={userQuestion:t.message,major:t.majorCategory,subField:t.subCategory,conversationId:t.sessionId,suggestCount:t.suggestCount??3,followupMode:t.followupMode??"multi"},o=await d.chat(n);return{id:`ai-${Date.now()}`,content:o.aiResponse,timestamp:new Date().toISOString(),sessionId:o.conversationId,processingTime:0,suggestions:o.suggestions}}async sendFeedback(t){return console.log(`Feedback received for message ${t.messageId}: ${t.feedback}`),{success:!0,message:"Feedback recorded"}}async testConnection(){try{return await this.checkHealth(),!0}catch{return!1}}}const f=new h;async function w(){if(!r)throw new Error("백엔드 주소 미설정: .env.local의 NEXT_PUBLIC_BACKEND_BASE를 확인하세요.");return await(await fetch(`${r}/health`,{credentials:"omit"})).text().catch(()=>"")}async function E(){if(!r)throw new Error("백엔드 주소 미설정: .env.local의 NEXT_PUBLIC_BACKEND_BASE를 확인하세요.");try{const e=await w();console.log("Health:",e)}catch(e){throw console.warn("⚠️ Backend validation failed:",e),e}}function S(e){if(!r)throw new Error("BACKEND_BASE_NOT_SET");const t=new URL(`${r}/chat/stream`);t.searchParams.set("q",e.q),t.searchParams.set("major",e.major),t.searchParams.set("subField",e.subField),t.searchParams.set("conversationId",e.conversationId);const n=new EventSource(t.toString(),{withCredentials:!1});return n.onmessage=o=>{var c,i,a;try{const s=JSON.parse(o.data);s.type==="start"?(c=e.onStart)==null||c.call(e):s.type==="answer_delta"?e.onDelta(s.text||""):s.type==="done"?((i=e.onDone)==null||i.call(e),n.close()):s.type==="error"&&((a=e.onError)==null||a.call(e,s.message||"stream error"),n.close())}catch{}},n.onerror=()=>{var o;(o=e.onError)==null||o.call(e,"sse connection error"),n.close()},()=>n.close()}async function A(e){if(!r)throw new Error("BACKEND_BASE_NOT_SET");const n=await(await fetch(`${r}/suggestions`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"omit",body:JSON.stringify(e)})).json().catch(()=>({suggestions:[]}));return Array.isArray(n==null?void 0:n.suggestions)?n.suggestions:[]}export{y as A,f as a,E as e,A as f,S as s};
