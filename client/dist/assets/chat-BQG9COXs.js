import{j as e,c as F,a as z,u as D}from"./index-B1NjirgS.js";import{r as l}from"./vendor-CwHBbTcV.js";import{B as g}from"./button-CkPipuGn.js";import{C as w,a as k}from"./card-BXh-_-Bf.js";import{T as R,d as T,e as $,f as E,A as L,R as U,g as _,L as S,C as A,h as P,i as B}from"./lucide-2YYKKs9f.js";import{c as K,f as Q}from"./api-CZYcWeBi.js";import{g as q,a as G}from"./categories-BlY_H3dN.js";const M=l.forwardRef(({className:s,type:m,...i},c)=>e.jsx("input",{type:m,className:F("flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",s),ref:c,...i}));M.displayName="Input";function H({messageId:s,onFeedback:m,onComment:i,className:c=""}){const[n,o]=l.useState(null),[p,r]=l.useState(!1),[u,d]=l.useState(""),x=h=>{o(h),m?.(h,s),h==="positive"&&setTimeout(()=>o(null),2e3)},j=()=>{u.trim()&&(i?.(u.trim(),s),d(""),r(!1))},v=h=>{h.key==="Enter"&&!h.shiftKey&&(h.preventDefault(),j())};return e.jsxs("div",{className:`flex items-center space-x-2 mt-2 ${c}`,children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(g,{variant:"ghost",size:"sm",onClick:()=>x("positive"),className:`h-8 px-2 ${n==="positive"?"bg-green-100 text-green-700 hover:bg-green-200":"hover:bg-gray-100"}`,"aria-label":"긍정적 피드백","aria-pressed":n==="positive",children:e.jsx(R,{className:"w-4 h-4"})}),e.jsx(g,{variant:"ghost",size:"sm",onClick:()=>x("negative"),className:`h-8 px-2 ${n==="negative"?"bg-red-100 text-red-700 hover:bg-red-200":"hover:bg-gray-100"}`,"aria-label":"부정적 피드백","aria-pressed":n==="negative",children:e.jsx(T,{className:"w-4 h-4"})})]}),e.jsx(g,{variant:"ghost",size:"sm",onClick:()=>r(!p),className:"h-8 px-2 hover:bg-gray-100","aria-label":"코멘트 추가","aria-expanded":p,children:e.jsx($,{className:"w-4 h-4"})}),n&&e.jsx("span",{className:"text-sm text-gray-600 ml-2",children:n==="positive"?"👍 도움이 되었습니다":"👎 개선이 필요합니다"}),p&&e.jsxs("div",{className:"flex-1 ml-2",children:[e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("textarea",{value:u,onChange:h=>d(h.target.value),onKeyPress:v,placeholder:"의견을 입력해주세요...",className:"flex-1 px-3 py-2 border border-gray-300 rounded-md text-sm resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent",rows:2,maxLength:500}),e.jsxs("div",{className:"flex flex-col space-y-1",children:[e.jsx(g,{size:"sm",onClick:j,disabled:!u.trim(),className:"h-8 px-3",children:"전송"}),e.jsx(g,{variant:"ghost",size:"sm",onClick:()=>{r(!1),d("")},className:"h-6 px-2 text-xs",children:"취소"})]})]}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:[u.length,"/500자"]})]})]})}function J({suggestions:s,onSuggestionClick:m,disabled:i=!1}){return s?.length?e.jsxs("div",{className:"mt-4 pt-3 border-t border-gray-100",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(E,{className:"w-3.5 h-3.5 text-blue-500"}),e.jsx("span",{className:"text-xs font-medium text-gray-600",children:"이어서 물어보기"})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:s.slice(0,5).map((c,n)=>e.jsx(g,{variant:"ghost",size:"sm",onClick:()=>m(c),disabled:i,className:`
              h-auto min-h-[32px] px-3 py-2 text-xs
              bg-blue-50 hover:bg-blue-100 
              text-blue-700 hover:text-blue-800
              border border-blue-200 hover:border-blue-300
              rounded-full transition-all duration-200
              disabled:opacity-50 disabled:cursor-not-allowed
              max-w-[280px] text-left justify-start
              shadow-sm hover:shadow-md
            `,title:c.length>35?c:void 0,children:e.jsx("span",{className:"truncate leading-relaxed",children:c.length>35?`${c.slice(0,35)}...`:c})},`msg-suggestion-${n}`))}),s.length>5&&e.jsxs("p",{className:"text-xs text-gray-400 mt-2",children:["+",s.length-5,"개 더 있음"]})]}):null}function O(){const s=l.useRef(null),m=l.useRef([]),i=l.useCallback(()=>{s.current={startTime:performance.now(),totalChunks:0,totalChars:0,averageChunkSize:0,streamingDuration:0,charsPerSecond:0},m.current=[]},[]),c=l.useCallback(r=>{if(!s.current)return;const u=performance.now(),d=r.length;s.current.totalChunks++,s.current.totalChars+=d,s.current.averageChunkSize=s.current.totalChars/s.current.totalChunks,s.current.firstChunkTime||(s.current.firstChunkTime=u),s.current.lastChunkTime=u,m.current.push(u)},[]),n=l.useCallback(()=>{if(!s.current)return;const r=performance.now();s.current.streamingDuration=r-s.current.startTime,s.current.streamingDuration>0&&(s.current.charsPerSecond=s.current.totalChars/s.current.streamingDuration*1e3),typeof window<"u"&&window.location.hostname==="localhost"&&console.log("📊 스트리밍 성능 메트릭:",{총_응답시간:`${(s.current.streamingDuration/1e3).toFixed(2)}초`,총_문자수:s.current.totalChars,총_청크수:s.current.totalChunks,평균_청크크기:s.current.averageChunkSize.toFixed(1),초당_문자수:s.current.charsPerSecond.toFixed(1),첫_청크_지연:s.current.firstChunkTime?`${((s.current.firstChunkTime-s.current.startTime)/1e3).toFixed(2)}초`:"N/A"}),s.current.totalChars>100},[]),o=l.useCallback(()=>s.current,[]),p=l.useCallback(()=>{s.current=null,m.current=[]},[]);return{startStreaming:i,recordChunk:c,endStreaming:n,getMetrics:o,reset:p}}function V(s){const[m,i]=l.useState([]),[c,n]=l.useState(!1),[o,p]=l.useState(),[r,u]=l.useState(()=>{if(typeof window>"u")return"cid-server";const N=localStorage.getItem("cid"),C=N??crypto.randomUUID();return N||localStorage.setItem("cid",C),C}),d=l.useRef(!1),{endStreaming:x}=O();async function j(N){if(!N.trim())return;if(d.current){console.warn("[useChat] Duplicate send attempt blocked");return}d.current=!0,n(!0);const C=crypto.randomUUID();i(a=>[...a,{role:"user",text:N,messageId:C}]);let y;const t=crypto.randomUUID();i(a=>(y=a.length,[...a,{role:"assistant",text:"",suggestions:[],messageId:t}]));try{const a=await K({userQuestion:N,major:s.major,subField:s.subField,conversationId:r,followupMode:"multi",suggestCount:s.suggestCount||3});if(i(f=>{const b=[...f];return b[y]&&(b[y]={...b[y],text:a.aiResponse,suggestions:a.suggestions||[]}),b}),a.conversationId&&a.conversationId!==r&&(u(a.conversationId),localStorage.setItem("cid",a.conversationId)),(!a.suggestions||a.suggestions.length===0)&&s.suggestCount&&s.suggestCount>0){console.log("[useChat] No suggestions in main response, fetching separately...");try{const f=await Q({conversationId:a.conversationId,major:s.major,subField:s.subField,suggestCount:s.suggestCount});f.length>0&&(console.log("[useChat] Fallback suggestions received:",f.length,"items"),i(b=>b.map(I=>I.messageId===t?{...I,suggestions:f}:I)))}catch(f){console.warn("[useChat] Fallback suggestions failed:",f)}}n(!1),x()}catch(a){n(!1),p(a instanceof Error?a.message:"채팅 중 오류가 발생했습니다."),i(f=>f.filter(b=>b.messageId!==t)),x()}finally{d.current=!1}}const v=l.useCallback(()=>{n(!1),x(),d.current=!1},[x]);return l.useEffect(()=>()=>{x(),d.current=!1},[x]),l.useMemo(()=>({messages:m,loading:c,error:o,conversationId:r,send:j,cancel:v}),[m,c,o,r,j,v])}function ae(){const[,s]=z("/chat/:majorId/:subId"),[,m]=D(),i=s?.majorId,c=s?.subId,n=l.useMemo(()=>i?q(i):null,[i]),o=l.useMemo(()=>i&&c?G(i,c):null,[i,c]);l.useEffect(()=>{n&&o&&console.log("[Chat] Initialized with:",{major:n.name,subField:o.name})},[n,o]);const{messages:p,loading:r,error:u,send:d}=V({major:n?.name||"",subField:o?.name||"",suggestCount:3,conversationId:void 0}),[x,j]=l.useState(""),v=async t=>{if(t.preventDefault(),!x.trim()||r)return;const a=x.trim();j(""),await d(a)},h=async t=>{r||await d(t)},N=async t=>{r||await d(t)},C=()=>{window.location.reload()},y=()=>{const t=p.filter(a=>a.role==="user").pop();t&&d(t.text)};return!n||!o?e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 mb-4",children:"카테고리를 찾을 수 없습니다"}),e.jsx(g,{onClick:()=>m("/"),children:"홈으로 돌아가기"})]})}):e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx("div",{className:"bg-white border-b",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"flex items-center justify-between h-16",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs(g,{variant:"ghost",size:"sm",onClick:()=>m("/"),className:"flex items-center space-x-2",children:[e.jsx(L,{className:"w-4 h-4"}),e.jsx("span",{children:"카테고리로 돌아가기"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{className:"text-sm text-gray-500",children:"💻"}),e.jsx("span",{className:"font-medium",children:n.name}),e.jsx("span",{className:"text-gray-400",children:">"}),e.jsx("span",{className:"font-medium",children:o.name})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[u&&e.jsxs(g,{variant:"outline",size:"sm",onClick:y,className:"flex items-center space-x-2","data-testid":"button-retry",children:[e.jsx(U,{className:"w-4 h-4"}),e.jsx("span",{children:"재시도"})]}),e.jsxs(g,{variant:"outline",onClick:C,className:"flex items-center space-x-2","data-testid":"button-clear-chat",children:[e.jsx(_,{className:"w-4 h-4"}),e.jsx("span",{children:"대화 초기화"})]})]})]})})}),e.jsxs("div",{className:"max-w-4xl mx-auto p-4 sm:p-6 lg:p-8",children:[e.jsx(w,{className:"mb-6 bg-blue-50 border-blue-200",children:e.jsxs(k,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(S,{className:"w-5 h-5 text-blue-600"}),e.jsxs("h2",{className:"text-lg font-semibold text-blue-800",children:[n.name," - ",o.name," 카테고리를 선택했습니다"]})]}),e.jsx("p",{className:"text-blue-700",children:"AI 튜터와 함께 학습하세요. 궁금한 것을 자유롭게 질문해보세요!"})]})}),e.jsx(w,{className:"mb-6 bg-amber-50 border-amber-200",children:e.jsxs(k,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-3",children:[e.jsx(S,{className:"w-5 h-5 text-amber-600"}),e.jsx("h3",{className:"font-semibold text-amber-800",children:"질문 예시"})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:o.sampleQuestions?.map((t,a)=>e.jsx(g,{variant:"outline",size:"sm",onClick:()=>N(t),className:"text-xs bg-white hover:bg-amber-100 border-amber-300 text-amber-700","data-testid":`button-sample-${a}`,disabled:r,children:t},a))||e.jsx("p",{className:"text-sm text-gray-500",children:"예시 질문이 없습니다"})})]})}),e.jsx(w,{className:"mb-6 bg-white",children:e.jsx(k,{className:"p-0",children:e.jsxs("div",{className:"h-96 overflow-y-auto p-4 space-y-4","data-testid":"chat-messages",children:[p.filter(t=>t.role==="user"||t.role==="assistant"&&(t.text.trim()||!r)).map((t,a)=>e.jsx("div",{className:`flex ${t.role==="user"?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-xs lg:max-w-md ${t.role==="user"?"bg-primary text-white":"bg-gray-100 text-gray-800"} px-4 py-2 rounded-lg shadow-sm`,"data-testid":`message-${t.role}-${a}`,children:[e.jsx("p",{className:"whitespace-pre-wrap",children:t.text}),t.role==="assistant"&&t.suggestions&&t.suggestions.length>0&&e.jsx(J,{suggestions:t.suggestions,onSuggestionClick:h,disabled:r}),t.role==="assistant"&&t.text.trim()&&!r&&e.jsx("div",{className:"mt-2",children:e.jsx(H,{messageId:t.messageId,onFeedback:(f,b)=>{console.log("Feedback:",f,b)}})})]})},t.messageId)),r&&e.jsx("div",{className:"flex justify-start",children:e.jsx("div",{className:"bg-gray-100 text-gray-800 px-4 py-3 rounded-lg shadow-sm max-w-xs lg:max-w-md",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsxs("div",{className:"flex space-x-1",children:[e.jsx("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce"}),e.jsx("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"0.1s"}}),e.jsx("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"0.2s"}})]}),e.jsx("span",{className:"text-sm text-gray-600",children:"AI가 답변을 생성하고 있습니다..."})]})})}),u&&e.jsx("div",{className:"flex justify-center",children:e.jsxs("div",{className:"bg-red-50 text-red-700 px-4 py-2 rounded-lg flex items-center space-x-2",children:[e.jsx(A,{className:"w-4 h-4"}),e.jsx("span",{children:u})]})})]})})}),e.jsx(w,{className:"bg-white",children:e.jsxs(k,{className:"p-4",children:[e.jsxs("form",{onSubmit:v,className:"flex space-x-2",children:[e.jsx(M,{value:x,onChange:t=>j(t.target.value),placeholder:"궁금한 것을 질문해보세요...",className:"flex-1",disabled:r,"data-testid":"input-message"}),e.jsx(g,{type:"submit",disabled:!x.trim()||r,className:"bg-primary text-white","data-testid":"button-send",children:r?e.jsx(P,{className:"w-4 h-4 animate-spin"}):e.jsx(B,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"mt-2 text-xs text-gray-500 space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Enter를 눌러 전송 • Shift+Enter로 줄바꿈"}),e.jsx("span",{className:"text-gray-400",children:"Ctrl+K: 입력창 포커스"})]}),e.jsx("div",{className:"text-gray-400",children:"Ctrl+Enter: 빠른 전송 • Ctrl+L: 대화 초기화"})]})]})})]})]})}export{ae as default};
