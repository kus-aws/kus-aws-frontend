import{c as f,r as a,j as e,f as J,k as K,l as R,A as z,i as X,h as Y,m as _,n as ee}from"./index-BpHKCCMK.js";import{B as y}from"./button-BBrZasFM.js";import{C as I,c as M}from"./card-D7Q8maA4.js";import{g as se,a as te,A as ae}from"./categories-BcpXifKX.js";import{C as B}from"./circle-alert-DF05hNVo.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ne=f("Lightbulb",[["path",{d:"M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5",key:"1gvzjb"}],["path",{d:"M9 18h6",key:"x1upvd"}],["path",{d:"M10 22h4",key:"ceow96"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const re=f("LoaderCircle",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ie=f("RefreshCw",[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const le=f("RotateCcw",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ce=f("Send",[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const de=f("Star",[["polygon",{points:"12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2",key:"8f66p6"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const oe=f("ThumbsDown",[["path",{d:"M17 14V2",key:"8ymqnk"}],["path",{d:"M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22a3.13 3.13 0 0 1-3-3.88Z",key:"m61m77"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const me=f("ThumbsUp",[["path",{d:"M7 10v12",key:"1qc93n"}],["path",{d:"M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2a3.13 3.13 0 0 1 3 3.88Z",key:"emmmcr"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ue=f("WifiOff",[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}],["path",{d:"M5 12.859a10 10 0 0 1 5.17-2.69",key:"1dl1wf"}],["path",{d:"M19 12.859a10 10 0 0 0-2.007-1.523",key:"4k23kn"}],["path",{d:"M2 8.82a15 15 0 0 1 4.177-2.643",key:"1grhjp"}],["path",{d:"M22 8.82a15 15 0 0 0-11.288-3.764",key:"z3jwby"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xe=f("Wifi",[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M2 8.82a15 15 0 0 1 20 0",key:"dnpr2z"}],["path",{d:"M5 12.859a10 10 0 0 1 14 0",key:"1x1e6c"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}]]),O=a.forwardRef(({className:s,type:c,...i},o)=>e.jsx("input",{type:c,className:J("flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",s),ref:o,...i}));O.displayName="Input";function he({text:s,speed:c=50,onComplete:i,className:o=""}){const[d,l]=a.useState(""),[r,u]=a.useState(0);return a.useEffect(()=>{if(r<s.length){const x=setTimeout(()=>{l(m=>m+s[r]),u(m=>m+1)},c);return()=>clearTimeout(x)}else i&&i()},[r,s,c,i]),a.useEffect(()=>{l(""),u(0)},[s]),e.jsxs("span",{className:o,children:[d,r<s.length&&e.jsx("span",{className:"animate-pulse",children:"|"})]})}function fe({messageId:s,onFeedbackSubmitted:c}){const[i,o]=a.useState(null),[d,l]=a.useState(!1),{toast:r}=K(),u=async x=>{if(!(i||d)){l(!0);try{await R.sendFeedback({messageId:s,feedback:x}),o(x),c==null||c(x),r({title:"피드백 감사합니다!",description:x==="like"?"도움이 되었다니 기쁩니다.":"더 나은 답변을 위해 노력하겠습니다."})}catch{r({title:"피드백 전송 실패",description:"잠시 후 다시 시도해주세요.",variant:"destructive"})}finally{l(!1)}}};return e.jsxs("div",{className:"flex items-center space-x-2 mt-2",children:[e.jsx(y,{variant:"ghost",size:"sm",onClick:()=>u("like"),disabled:i!==null||d,className:`h-6 px-2 ${i==="like"?"text-green-600 bg-green-50":"text-gray-400 hover:text-green-600"}`,"data-testid":`feedback-like-${s}`,children:e.jsx(me,{className:"w-3 h-3"})}),e.jsx(y,{variant:"ghost",size:"sm",onClick:()=>u("dislike"),disabled:i!==null||d,className:`h-6 px-2 ${i==="dislike"?"text-red-600 bg-red-50":"text-gray-400 hover:text-red-600"}`,"data-testid":`feedback-dislike-${s}`,children:e.jsx(oe,{className:"w-3 h-3"})})]})}function ge(){const[s,c]=a.useState(navigator.onLine),[i,o]=a.useState("checking");return a.useEffect(()=>{const d=()=>c(!0),l=()=>c(!1);return window.addEventListener("online",d),window.addEventListener("offline",l),()=>{window.removeEventListener("online",d),window.removeEventListener("offline",l)}},[]),a.useEffect(()=>{const d=async()=>{if(!s){o("disconnected");return}o("checking");try{const r=await R.testConnection();o(r?"connected":"disconnected")}catch{o("disconnected")}};d();const l=setInterval(d,3e4);return()=>clearInterval(l)},[s]),s?i==="disconnected"?e.jsxs("div",{className:"flex items-center space-x-2 bg-amber-50 text-amber-700 px-3 py-2 rounded-lg text-sm",children:[e.jsx(B,{className:"w-4 h-4"}),e.jsx("span",{children:"서버 연결 중 문제가 발생했습니다"})]}):i==="checking"?e.jsxs("div",{className:"flex items-center space-x-2 bg-blue-50 text-blue-700 px-3 py-2 rounded-lg text-sm",children:[e.jsx(xe,{className:"w-4 h-4 animate-pulse"}),e.jsx("span",{children:"연결 상태 확인 중..."})]}):null:e.jsxs("div",{className:"flex items-center space-x-2 bg-red-50 text-red-700 px-3 py-2 rounded-lg text-sm",children:[e.jsx(ue,{className:"w-4 h-4"}),e.jsx("span",{children:"오프라인 상태입니다"})]})}function pe(){const[s,c]=a.useState({data:null,loading:!1,error:null}),i=a.useCallback(async(d,l={})=>{c(r=>({...r,loading:!0,error:null}));try{const r=await d();return c({data:r,loading:!1,error:null}),l.onSuccess&&l.onSuccess(r),r}catch(r){const u=r instanceof z?r.message:"An unexpected error occurred";throw c(x=>({...x,loading:!1,error:u})),l.onError&&r instanceof z&&l.onError(r),r}},[]),o=a.useCallback(()=>{c({data:null,loading:!1,error:null})},[]);return{...s,execute:i,reset:o}}function Ne(){const[,s]=X("/chat/:majorId/:subId"),[,c]=Y(),{toast:i}=K();a.useEffect(()=>{_().catch(t=>{console.error("❌ Backend validation failed:",t),i({title:"백엔드 연결 오류",description:t.message||"백엔드 서버에 연결할 수 없습니다.",variant:"destructive"})})},[i]);const[o,d]=a.useState({messages:[],sessionId:`session-${Date.now()}`,isTyping:!1,error:null,lastAIMessageId:null}),[l,r]=a.useState(""),[u,x]=a.useState(null),[m,S]=a.useState(!1),[w,C]=a.useState(null),[q,E]=a.useState(0),k=["AI가 답변을 생성하고 있어요...","최적의 답변을 찾고 있어요...","곧 완료됩니다..."];a.useEffect(()=>{if(!m){E(0);return}const t=setInterval(()=>{E(n=>(n+1)%k.length)},2e3);return()=>clearInterval(t)},[m,k.length]);const[ye,L]=a.useState({conversationId:`session-${Date.now()}`,answer:"",isStreaming:!1,suggestions:[],isLoadingSuggestions:!1}),[T,H]=a.useState(null);a.useState(!1),a.useState(!1),a.useState([]);const $=a.useRef(null),b=pe(),g=a.useMemo(()=>s!=null&&s.majorId?se(s.majorId):null,[s==null?void 0:s.majorId]),p=a.useMemo(()=>s!=null&&s.majorId&&(s!=null&&s.subId)?te(s.majorId,s.subId):null,[s==null?void 0:s.majorId,s==null?void 0:s.subId]);a.useEffect(()=>{if(s!=null&&s.majorId&&(s!=null&&s.subId)&&g&&p){const t={id:`system-${Date.now()}`,content:`${g.name} - ${p.name} 카테고리를 선택했습니다. 궁금한 것을 자유롭게 질문해보세요!`,sender:"system",timestamp:new Date};d(n=>({...n,messages:[t],error:null,lastAIMessageId:null}))}},[s==null?void 0:s.majorId,s==null?void 0:s.subId,g,p]),a.useEffect(()=>{W()},[o.messages]);const W=()=>{var t;(t=$.current)==null||t.scrollIntoView({behavior:"smooth"})},N=async t=>{const n=l.trim();if(!n||m||!(s!=null&&s.majorId)||!(s!=null&&s.subId))return;const j={id:`user-${Date.now()}`,content:n,sender:"user",timestamp:new Date};d(h=>({...h,messages:[...h.messages,j],error:null,lastAIMessageId:null})),r(""),L(h=>({...h,answer:"",isStreaming:!1,suggestions:[],isLoadingSuggestions:!1,streamError:void 0,suggestionsError:void 0})),T&&(T(),H(null)),S(!0),C(null);try{const h=await ee.chat({userQuestion:n,major:s.majorId,subField:s.subId,conversationId:o.sessionId,suggestCount:3,followupMode:"multi"}),v={id:`ai-${Date.now()}`,content:h.aiResponse,sender:"ai",timestamp:new Date,suggestions:h.suggestions};d(A=>({...A,messages:[...A.messages,v],lastAIMessageId:v.id}))}catch(h){const v=h instanceof Error?h.message:"잠시 후 다시 시도해주세요.";console.error("Chat error:",h),C(v),i({title:"메시지 전송 실패",description:v,variant:"destructive"})}finally{S(!1)}},P=()=>{if(u&&b.data){const t={id:b.data.id,content:u,sender:"ai",timestamp:new Date(b.data.timestamp),processingTime:b.data.processingTime,suggestions:b.data.suggestions};d(n=>({...n,messages:[...n.messages,t],isTyping:!1,lastAIMessageId:t.id})),x(null)}},D=()=>{if(g&&p){const t={id:`system-${Date.now()}`,content:`${g.name} - ${p.name} 카테고리를 선택했습니다. 궁금한 것을 자유롭게 질문해보세요!`,sender:"system",timestamp:new Date},n=`session-${Date.now()}`;d({messages:[t],sessionId:n,isTyping:!1,error:null,lastAIMessageId:null}),L(j=>({...j,conversationId:n,answer:"",isStreaming:!1,suggestions:[],isLoadingSuggestions:!1,streamError:void 0,suggestionsError:void 0})),x(null),b.reset()}},Q=()=>{const t=[...o.messages].reverse().find(n=>n.sender==="user");t&&r(t.content)},U=t=>{r(t)},F=t=>{t.sender==="ai"&&g&&p&&i({title:"북마크 기능",description:"곧 구현될 예정입니다.",variant:"default"})},V=()=>{c(`/categories/${s==null?void 0:s.majorId}`)},Z=t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),N())};a.useEffect(()=>{const t=n=>{if((n.ctrlKey||n.metaKey)&&n.key==="Enter"&&(n.preventDefault(),l.trim()&&!m&&N()),(n.ctrlKey||n.metaKey)&&n.key==="k"){n.preventDefault();const j=document.querySelector('[data-testid="input-message"]');j==null||j.focus()}(n.ctrlKey||n.metaKey)&&n.key==="l"&&(n.preventDefault(),D())};return document.addEventListener("keydown",t),()=>document.removeEventListener("keydown",t)},[l,m]);const G=t=>t?t<1e3?`${t}ms`:`${(t/1e3).toFixed(1)}s`:"";return!g||!p?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-cyan-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h1",{className:"text-2xl font-bold text-text-primary mb-4",children:"잘못된 접근입니다"}),e.jsx(y,{onClick:()=>c("/"),"data-testid":"button-go-home",children:"홈으로 돌아가기"})]})}):e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-cyan-50",children:e.jsxs("div",{className:"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[e.jsxs("div",{className:"mb-6",children:[e.jsxs(y,{variant:"ghost",onClick:V,className:"mb-4","data-testid":"button-back-categories",children:[e.jsx(ae,{className:"w-4 h-4 mr-2"}),"카테고리로 돌아가기"]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"text-3xl",children:g.emoji}),e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold text-text-primary",children:[g.name," ",">"," ",p.name]}),e.jsx("p",{className:"text-gray-600",children:"AI 튜터와 함께 학습하세요"})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[w&&e.jsxs(y,{variant:"outline",size:"sm",onClick:Q,className:"flex items-center space-x-2","data-testid":"button-retry",children:[e.jsx(ie,{className:"w-4 h-4"}),e.jsx("span",{children:"재시도"})]}),e.jsxs(y,{variant:"outline",onClick:D,className:"flex items-center space-x-2","data-testid":"button-clear-chat",children:[e.jsx(le,{className:"w-4 h-4"}),e.jsx("span",{children:"대화 초기화"})]})]})]}),e.jsx("div",{className:"mt-4",children:e.jsx(ge,{})})]}),e.jsx(I,{className:"mb-6 bg-amber-50 border-amber-200",children:e.jsxs(M,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-3",children:[e.jsx(ne,{className:"w-5 h-5 text-amber-600"}),e.jsx("h3",{className:"font-semibold text-amber-800",children:"질문 예시"})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:p.sampleQuestions.map((t,n)=>e.jsx(y,{variant:"outline",size:"sm",onClick:()=>U(t),className:"text-xs bg-white hover:bg-amber-100 border-amber-300 text-amber-700","data-testid":`button-sample-${n}`,disabled:!1,children:t},n))})]})}),e.jsx(I,{className:"mb-6 bg-white",children:e.jsx(M,{className:"p-0",children:e.jsxs("div",{className:"h-96 overflow-y-auto p-4 space-y-4","data-testid":"chat-messages",children:[o.messages.map(t=>e.jsx("div",{className:`flex ${t.sender==="user"?"justify-end":t.sender==="system"?"justify-center":"justify-start"}`,children:e.jsxs("div",{className:`max-w-xs lg:max-w-md ${t.sender==="user"?"bg-primary text-white":t.sender==="system"?"bg-amber-100 text-amber-800 text-sm":"bg-gray-100 text-gray-800"} px-4 py-2 rounded-lg shadow-sm`,"data-testid":`message-${t.sender}-${t.id}`,children:[e.jsx("p",{className:"whitespace-pre-wrap",children:t.content}),e.jsx("div",{className:"flex items-center justify-between mt-1",children:e.jsxs("p",{className:`text-xs ${t.sender==="user"?"text-blue-100":t.sender==="system"?"text-amber-600":"text-gray-500"}`,children:[t.timestamp.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),t.processingTime&&e.jsxs("span",{className:"ml-2",children:["(",G(t.processingTime),")"]})]})}),t.sender==="ai"&&e.jsx("div",{className:"mt-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(fe,{messageId:t.id}),e.jsx(y,{variant:"ghost",size:"sm",onClick:()=>F(t),className:"text-yellow-600 hover:text-yellow-800","data-testid":`bookmark-${t.id}`,children:e.jsx(de,{className:"w-3 h-3"})})]})})]})},t.id)),o.isTyping&&u&&e.jsx("div",{className:"flex justify-start",children:e.jsx("div",{className:"bg-gray-100 text-gray-800 px-4 py-2 rounded-lg shadow-sm max-w-xs lg:max-w-md",children:e.jsx(he,{text:u,speed:30,onComplete:P})})}),m&&e.jsx("div",{className:"flex justify-start",children:e.jsx("div",{className:"bg-blue-50 text-blue-800 px-4 py-3 rounded-lg shadow-sm max-w-xs lg:max-w-md",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("div",{className:"flex space-x-1",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full animate-bounce"}),e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full animate-bounce",style:{animationDelay:"0.1s"}}),e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full animate-bounce",style:{animationDelay:"0.2s"}})]}),e.jsx("span",{className:"text-sm",children:k[q]})]})})}),w&&e.jsx("div",{className:"flex justify-center",children:e.jsxs("div",{className:"bg-red-50 text-red-700 px-4 py-2 rounded-lg flex items-center space-x-2",children:[e.jsx(B,{className:"w-4 h-4"}),e.jsx("span",{children:w})]})}),e.jsx("div",{ref:$})]})})}),e.jsx(I,{className:"bg-white",children:e.jsxs(M,{className:"p-4",children:[e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(O,{value:l,onChange:t=>r(t.target.value),onKeyPress:Z,placeholder:"궁금한 것을 질문해보세요...",className:"flex-1",disabled:m,"data-testid":"input-message"}),e.jsx(y,{onClick:()=>N(),disabled:!l.trim()||m,className:"bg-primary text-white","data-testid":"button-send",children:m?e.jsx(re,{className:"w-4 h-4 animate-spin"}):e.jsx(ce,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"mt-2 text-xs text-gray-500 space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Enter를 눌러 전송 • Shift+Enter로 줄바꿈"}),e.jsx("span",{className:"text-gray-400",children:"Ctrl+K: 입력창 포커스"})]}),e.jsx("div",{className:"text-gray-400",children:"Ctrl+Enter: 빠른 전송 • Ctrl+L: 대화 초기화"})]})]})})]})})}export{Ne as default};
