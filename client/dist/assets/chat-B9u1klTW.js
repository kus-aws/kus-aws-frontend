import{c as N,r as o,j as e,f as ee,k as P,i as se,h as te}from"./index-E_LpXTTp.js";import{B as p}from"./button-CmiTE8ls.js";import{C as $,c as T}from"./card-D2CI4bE0.js";import{g as ae,a as ne,A as re}from"./categories-BufZQLRT.js";import{a as _,A as B}from"./api-rx8LMB-i.js";import{C as K}from"./circle-alert-6J9ZNVRf.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ie=N("Lightbulb",[["path",{d:"M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5",key:"1gvzjb"}],["path",{d:"M9 18h6",key:"x1upvd"}],["path",{d:"M10 22h4",key:"ceow96"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const oe=N("LoaderCircle",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const le=N("RefreshCw",[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ce=N("RotateCcw",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const O=N("Send",[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const de=N("Square",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ue=N("Star",[["polygon",{points:"12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2",key:"8f66p6"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const me=N("ThumbsDown",[["path",{d:"M17 14V2",key:"8ymqnk"}],["path",{d:"M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22a3.13 3.13 0 0 1-3-3.88Z",key:"m61m77"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ge=N("ThumbsUp",[["path",{d:"M7 10v12",key:"1qc93n"}],["path",{d:"M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2a3.13 3.13 0 0 1 3 3.88Z",key:"emmmcr"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const he=N("WifiOff",[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}],["path",{d:"M5 12.859a10 10 0 0 1 5.17-2.69",key:"1dl1wf"}],["path",{d:"M19 12.859a10 10 0 0 0-2.007-1.523",key:"4k23kn"}],["path",{d:"M2 8.82a15 15 0 0 1 4.177-2.643",key:"1grhjp"}],["path",{d:"M22 8.82a15 15 0 0 0-11.288-3.764",key:"z3jwby"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xe=N("Wifi",[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M2 8.82a15 15 0 0 1 20 0",key:"dnpr2z"}],["path",{d:"M5 12.859a10 10 0 0 1 14 0",key:"1x1e6c"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}]]),A=o.forwardRef(({className:s,type:r,...a},n)=>e.jsx("input",{type:r,className:ee("flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",s),ref:n,...a}));A.displayName="Input";function fe({text:s,speed:r=50,onComplete:a,className:n=""}){const[i,u]=o.useState(""),[c,x]=o.useState(0);return o.useEffect(()=>{if(c<s.length){const d=setTimeout(()=>{u(f=>f+s[c]),x(f=>f+1)},r);return()=>clearTimeout(d)}else a&&a()},[c,s,r,a]),o.useEffect(()=>{u(""),x(0)},[s]),e.jsxs("span",{className:n,children:[i,c<s.length&&e.jsx("span",{className:"animate-pulse",children:"|"})]})}function be({messageId:s,onFeedbackSubmitted:r}){const[a,n]=o.useState(null),[i,u]=o.useState(!1),{toast:c}=P(),x=async d=>{if(!(a||i)){u(!0);try{await _.sendFeedback({messageId:s,feedback:d}),n(d),r==null||r(d),c({title:"í”¼ë“œë°± ê°ì‚¬í•©ë‹ˆë‹¤!",description:d==="like"?"ë„ì›€ì´ ë˜ì—ˆë‹¤ë‹ˆ ê¸°ì©ë‹ˆë‹¤.":"ë” ë‚˜ì€ ë‹µë³€ì„ ìœ„í•´ ë…¸ë ¥í•˜ê² ìŠµë‹ˆë‹¤."})}catch{c({title:"í”¼ë“œë°± ì „ì†¡ ì‹¤íŒ¨",description:"ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.",variant:"destructive"})}finally{u(!1)}}};return e.jsxs("div",{className:"flex items-center space-x-2 mt-2",children:[e.jsx(p,{variant:"ghost",size:"sm",onClick:()=>x("like"),disabled:a!==null||i,className:`h-6 px-2 ${a==="like"?"text-green-600 bg-green-50":"text-gray-400 hover:text-green-600"}`,"data-testid":`feedback-like-${s}`,children:e.jsx(ge,{className:"w-3 h-3"})}),e.jsx(p,{variant:"ghost",size:"sm",onClick:()=>x("dislike"),disabled:a!==null||i,className:`h-6 px-2 ${a==="dislike"?"text-red-600 bg-red-50":"text-gray-400 hover:text-red-600"}`,"data-testid":`feedback-dislike-${s}`,children:e.jsx(me,{className:"w-3 h-3"})})]})}function je(){const[s,r]=o.useState(navigator.onLine),[a,n]=o.useState("checking");return o.useEffect(()=>{const i=()=>r(!0),u=()=>r(!1);return window.addEventListener("online",i),window.addEventListener("offline",u),()=>{window.removeEventListener("online",i),window.removeEventListener("offline",u)}},[]),o.useEffect(()=>{const i=async()=>{if(!s){n("disconnected");return}n("checking");try{const c=await _.testConnection();n(c?"connected":"disconnected")}catch{n("disconnected")}};i();const u=setInterval(i,3e4);return()=>clearInterval(u)},[s]),s?a==="disconnected"?e.jsxs("div",{className:"flex items-center space-x-2 bg-amber-50 text-amber-700 px-3 py-2 rounded-lg text-sm",children:[e.jsx(K,{className:"w-4 h-4"}),e.jsx("span",{children:"ì„œë²„ ì—°ê²° ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤"})]}):a==="checking"?e.jsxs("div",{className:"flex items-center space-x-2 bg-blue-50 text-blue-700 px-3 py-2 rounded-lg text-sm",children:[e.jsx(xe,{className:"w-4 h-4 animate-pulse"}),e.jsx("span",{children:"ì—°ê²° ìƒíƒœ í™•ì¸ ì¤‘..."})]}):null:e.jsxs("div",{className:"flex items-center space-x-2 bg-red-50 text-red-700 px-3 py-2 rounded-lg text-sm",children:[e.jsx(he,{className:"w-4 h-4"}),e.jsx("span",{children:"ì˜¤í”„ë¼ì¸ ìƒíƒœì…ë‹ˆë‹¤"})]})}function pe({state:s,onSuggestionClick:r,onRetryStream:a,onRetrySuggestions:n}){return e.jsx("div",{className:"flex justify-start",children:e.jsxs("div",{className:"bg-gray-100 text-gray-800 px-4 py-2 rounded-lg shadow-sm max-w-xs lg:max-w-md",children:[s.answer&&e.jsx("div",{className:"whitespace-pre-wrap",children:s.answer}),s.isStreaming&&e.jsxs("div",{className:"text-xs text-gray-500 mt-1 animate-pulse flex items-center",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full mr-1 animate-bounce"}),"ìƒì„± ì¤‘..."]}),s.streamError&&e.jsx("div",{className:"mt-2 p-2 bg-red-50 border border-red-200 rounded text-red-700 text-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:s.streamError}),e.jsx(p,{size:"sm",variant:"ghost",onClick:a,className:"text-red-700 hover:bg-red-100 ml-2",children:"ë‹¤ì‹œ ì‹œë„"})]})}),!s.isStreaming&&!s.streamError&&s.answer&&e.jsxs("div",{className:"mt-3",children:[s.isLoadingSuggestions&&e.jsx("div",{className:"text-xs text-gray-500 animate-pulse",children:"ì—°ê³„ ì§ˆë¬¸ì„ ì¤€ë¹„ ì¤‘..."}),!s.isLoadingSuggestions&&s.suggestions.length>0&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-600 mb-2",children:"ì—°ê³„ ì§ˆë¬¸"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:s.suggestions.map((i,u)=>e.jsx(p,{variant:"outline",size:"sm",onClick:()=>r(i),className:"text-xs bg-white hover:bg-blue-50 border-blue-200 text-blue-700 max-w-full",title:i,children:e.jsx("span",{className:"truncate",children:i})},u))})]}),s.suggestionsError&&e.jsx("div",{className:"mt-2 p-2 bg-orange-50 border border-orange-200 rounded text-orange-700 text-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"ì¶”ì²œ ì§ˆë¬¸ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."}),e.jsx(p,{size:"sm",variant:"ghost",onClick:n,className:"text-orange-700 hover:bg-orange-100 ml-2",children:"ì¬ì‹œë„"})]})})]})]})})}function ye(s){const r=new URL(`${s.baseUrl}/chat/stream`);r.searchParams.set("q",s.q),r.searchParams.set("major",s.major),r.searchParams.set("subField",s.subField),r.searchParams.set("conversationId",s.conversationId);const a=new EventSource(r.toString());return a.onmessage=n=>{try{const i=JSON.parse(n.data);switch(i.type){case"start":s.onStart(i.conversationId);break;case"answer_delta":s.onDelta(i.text||"");break;case"done":a.close(),s.onDone();break;case"error":a.close(),s.onError(i.message||"ìŠ¤íŠ¸ë¦¬ë° ì˜¤ë¥˜");break}}catch{}},a.onerror=()=>{a.close(),s.onError("ì—°ê²°ì´ ì›í™œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")},()=>a.close()}async function we(s,r){const a=await fetch(`${s}/suggestions`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!a.ok)throw new Error("ì¶”ì²œ ì§ˆë¬¸ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");const n=await a.json();return ve(n.suggestions||[])}function ve(s){const r=new Set,a=[];for(let n of s){if(n=n.trim(),!n)continue;n.length>140&&(n=n.substring(0,140)),!n.endsWith("?")&&!n.endsWith(".")&&(n+="?");const i=n.toLowerCase();if(!r.has(i)&&(r.add(i),a.push(n),a.length>=5))break}return a}function Se({messages:s,loading:r}){return e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4","aria-live":"polite","aria-label":"Chat conversation",children:[s.map((a,n)=>e.jsx("div",{className:`flex ${a.role==="user"?"justify-end":"justify-start"}`,children:e.jsx("div",{className:`max-w-xs lg:max-w-md px-4 py-2 rounded-lg shadow-sm ${a.role==="user"?"bg-blue-500 text-white":"bg-gray-100 text-gray-800"}`,children:e.jsxs("p",{className:"whitespace-pre-wrap",children:[a.text,a.role==="assistant"&&r&&n===s.length-1&&e.jsx("span",{className:"inline-block w-2 h-4 ml-1 bg-gray-600 animate-pulse"})]})})},n)),r&&s.length===1&&e.jsx("div",{className:"flex justify-start",children:e.jsx("div",{className:"bg-gray-100 px-4 py-2 rounded-lg shadow-sm max-w-xs lg:max-w-md",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"h-4 bg-gray-300 rounded animate-pulse"}),e.jsx("div",{className:"h-4 bg-gray-300 rounded w-3/4 animate-pulse"})]})})})]})}function Ne({onSend:s,onCancel:r,loading:a,disabled:n=!1}){const[i,u]=o.useState(""),c=d=>{d.preventDefault(),!(!i.trim()||a||n)&&(s(i.trim()),u(""))},x=d=>{d.key==="Enter"&&!d.shiftKey&&(d.preventDefault(),c(d))};return e.jsxs("form",{onSubmit:c,className:"border-t bg-white p-4",children:[e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(A,{value:i,onChange:d=>u(d.target.value),onKeyDown:x,placeholder:"ê¶ê¸ˆí•œ ê²ƒì„ ì§ˆë¬¸í•´ë³´ì„¸ìš”...",disabled:n,className:"flex-1","aria-label":"ë©”ì‹œì§€ ì…ë ¥"}),a?e.jsx(p,{type:"button",onClick:r,variant:"outline",size:"icon",className:"shrink-0","aria-label":"ì „ì†¡ ì¤‘ë‹¨",children:e.jsx(de,{className:"h-4 w-4"})}):e.jsx(p,{type:"submit",disabled:!i.trim()||n,size:"icon",className:"shrink-0","aria-label":"ë©”ì‹œì§€ ì „ì†¡",children:e.jsx(O,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"mt-2 text-xs text-gray-500",children:[e.jsx("span",{children:"Enterë¥¼ ëˆŒëŸ¬ ì „ì†¡ â€¢ Shift+Enterë¡œ ì¤„ë°”ê¿ˆ"}),a&&e.jsx("span",{className:"ml-4 text-orange-600",children:"ì „ì†¡ ì¤‘... (ì¤‘ë‹¨í•˜ë ¤ë©´ â¹ï¸ í´ë¦­)"})]})]})}function ke({items:s,onSelect:r}){return s!=null&&s.length?e.jsx("div",{className:"flex flex-wrap gap-2 mt-3",children:s.map(a=>e.jsx("button",{onClick:()=>r(a),className:"px-3 py-1 rounded-full border text-sm hover:bg-gray-50",children:a},a))}):null}const Ie={BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,SSR:!1,VITE_API_BASE_URL:"https://2kdtuncj36tas5twwm7dsgpz5y0bkfkw.lambda-url.us-east-1.on.aws"},L="https://2kdtuncj36tas5twwm7dsgpz5y0bkfkw.lambda-url.us-east-1.on.aws".replace(/\/+$/,"");console.log("ğŸ”§ Backend URL:",L);console.warn("âš ï¸ NEXT_PUBLIC_BACKEND_BASE not set, using fallback URL"),console.log("Available env vars:",Object.keys(Ie).filter(s=>s.startsWith("NEXT_PUBLIC")));async function Ce(){return console.log("ğŸ” Health check URL:",`${L}/health`),(await fetch(`${L}/health`,{credentials:"omit"})).json()}function Ee(s){const{q:r,major:a,subField:n,conversationId:i,onStart:u,onDelta:c,onDone:x,onError:d,signal:f}=s,v=new URL(`${L}/chat/stream`);v.searchParams.set("q",r),v.searchParams.set("major",a),v.searchParams.set("subField",n),v.searchParams.set("conversationId",i),console.log("ğŸŒŠ Starting SSE stream:",v.toString());const m=new EventSource(v.toString(),{withCredentials:!1}),b=()=>m.close();return f&&f.addEventListener("abort",b,{once:!0}),m.onmessage=j=>{try{console.log("ğŸ“¨ SSE message received:",j.data);const g=JSON.parse(j.data);g.type==="start"?(console.log("ğŸš€ SSE stream started:",g.conversationId),u==null||u(g.conversationId)):g.type==="answer_delta"?c(g.text):g.type==="done"?(console.log("âœ… SSE stream completed"),x==null||x(),m.close()):g.type==="error"&&(console.error("âŒ SSE stream error:",g.message),d==null||d(g.message),m.close())}catch(g){console.error("ğŸ”¥ SSE parse error:",g,"Raw data:",j.data),d==null||d("parse error"),m.close()}},m.onerror=j=>{console.error("ğŸ”¥ SSE Error:",j),console.log("ğŸ” EventSource readyState:",m.readyState),d==null||d("connection error"),m.close()},b}async function Me(s){const a=await(await fetch(`${L}/suggestions`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s),credentials:"omit"})).json();return Array.isArray(a==null?void 0:a.suggestions)?a.suggestions:[]}function Le(s){const[r,a]=o.useState([]),[n,i]=o.useState(!1),[u,c]=o.useState(),[x,d]=o.useState([]),[f,v]=o.useState(()=>{const g=typeof window<"u"?localStorage.getItem("cid"):null,I=s.conversationId??g??crypto.randomUUID();return!g&&typeof window<"u"&&localStorage.setItem("cid",I),I}),m=o.useRef(null);async function b(g){c(void 0),d([]),a(h=>[...h,{role:"user",text:g},{role:"assistant",text:""}]),i(!0);const I=new AbortController;m.current=I;const E=r.length+1;Ee({q:g,major:s.major,subField:s.subField,conversationId:f,onStart:h=>{h!==f&&(v(h),localStorage.setItem("cid",h))},onDelta:h=>{a(S=>{var D;const w=[...S];return w[E]={role:"assistant",text:(((D=w[E])==null?void 0:D.text)||"")+h},w})},onDone:async()=>{i(!1);try{const h=await Me({conversationId:f,major:s.major,subField:s.subField,suggestCount:s.suggestCount??3});d(h)}catch{}},onError:h=>{i(!1),c(h||"error")},signal:I.signal})}function j(){var g;(g=m.current)==null||g.abort(),i(!1)}return{messages:r,loading:n,error:u,suggestions:x,conversationId:f,send:b,cancel:j}}function De(){const[s,r]=o.useState({data:null,loading:!1,error:null}),a=o.useCallback(async(i,u={})=>{r(c=>({...c,loading:!0,error:null}));try{const c=await i();return r({data:c,loading:!1,error:null}),u.onSuccess&&u.onSuccess(c),c}catch(c){const x=c instanceof B?c.message:"An unexpected error occurred";throw r(d=>({...d,loading:!1,error:x})),u.onError&&c instanceof B&&u.onError(c),c}},[]),n=o.useCallback(()=>{r({data:null,loading:!1,error:null})},[]);return{...s,execute:a,reset:n}}function Be(){const[,s]=se("/chat/:majorId/:subId"),[,r]=te(),{toast:a}=P();o.useEffect(()=>{Ce().then(()=>{console.log("âœ… Backend health check passed")}).catch(t=>{console.warn("âš ï¸ Backend health check failed:",t)})},[]);const[n,i]=o.useState({messages:[],sessionId:`session-${Date.now()}`,isTyping:!1,error:null,lastAIMessageId:null}),[u,c]=o.useState(""),[x,d]=o.useState(null),[f,v]=o.useState(!0),m=Le({major:(s==null?void 0:s.majorId)||"",subField:(s==null?void 0:s.subId)||"",suggestCount:3}),[b,j]=o.useState({conversationId:`session-${Date.now()}`,answer:"",isStreaming:!1,suggestions:[],isLoadingSuggestions:!1}),[g,I]=o.useState(null);o.useState(!1),o.useState(!1),o.useState([]);const E=o.useRef(null),h=De(),S=o.useMemo(()=>s!=null&&s.majorId?ae(s.majorId):null,[s==null?void 0:s.majorId]),w=o.useMemo(()=>s!=null&&s.majorId&&(s!=null&&s.subId)?ne(s.majorId,s.subId):null,[s==null?void 0:s.majorId,s==null?void 0:s.subId]);o.useEffect(()=>{if(s!=null&&s.majorId&&(s!=null&&s.subId)&&S&&w){const t={id:`system-${Date.now()}`,content:`${S.name} - ${w.name} ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí–ˆìŠµë‹ˆë‹¤. ê¶ê¸ˆí•œ ê²ƒì„ ììœ ë¡­ê²Œ ì§ˆë¬¸í•´ë³´ì„¸ìš”!`,sender:"system",timestamp:new Date};i(l=>({...l,messages:[t],error:null,lastAIMessageId:null}))}},[s==null?void 0:s.majorId,s==null?void 0:s.subId,S,w]),o.useEffect(()=>{D()},[n.messages]);const D=()=>{var t;(t=E.current)==null||t.scrollIntoView({behavior:"smooth"})},M=async t=>{const l=t||u.trim();if(!l||b.isStreaming||!(s!=null&&s.majorId)||!(s!=null&&s.subId))return;const C={id:`user-${Date.now()}`,content:l,sender:"user",timestamp:new Date};i(y=>({...y,messages:[...y.messages,C],error:null,lastAIMessageId:null})),t||c(""),j(y=>({...y,answer:"",isStreaming:!1,suggestions:[],isLoadingSuggestions:!1,streamError:void 0,suggestionsError:void 0})),g&&(g(),I(null));const Y=ye({baseUrl:"https://2kdtuncj36tas5twwm7dsgpz5y0bkfkw.lambda-url.us-east-1.on.aws",q:l,major:s.majorId,subField:s.subId,conversationId:b.conversationId,onStart:y=>{j(k=>({...k,conversationId:y,isStreaming:!0}))},onDelta:y=>{j(k=>({...k,answer:k.answer+y}))},onDone:()=>{j(y=>({...y,isStreaming:!1})),setTimeout(()=>{const y=b.answer,k={id:`ai-${Date.now()}`,content:y,sender:"ai",timestamp:new Date};i(U=>({...U,messages:[...U.messages,k],lastAIMessageId:k.id})),R()},100)},onError:y=>{j(k=>({...k,isStreaming:!1,streamError:y})),a({title:"ì—°ê²° ì˜¤ë¥˜",description:y,variant:"destructive"})}});I(()=>Y)},F=()=>{if(x&&h.data){const t={id:h.data.id,content:x,sender:"ai",timestamp:new Date(h.data.timestamp),processingTime:h.data.processingTime,suggestions:h.data.suggestions};i(l=>({...l,messages:[...l.messages,t],isTyping:!1,lastAIMessageId:t.id})),d(null)}},z=()=>{if(S&&w){const t={id:`system-${Date.now()}`,content:`${S.name} - ${w.name} ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí–ˆìŠµë‹ˆë‹¤. ê¶ê¸ˆí•œ ê²ƒì„ ììœ ë¡­ê²Œ ì§ˆë¬¸í•´ë³´ì„¸ìš”!`,sender:"system",timestamp:new Date},l=`session-${Date.now()}`;i({messages:[t],sessionId:l,isTyping:!1,error:null,lastAIMessageId:null}),j(C=>({...C,conversationId:l,answer:"",isStreaming:!1,suggestions:[],isLoadingSuggestions:!1,streamError:void 0,suggestionsError:void 0})),d(null),h.reset()}},q=()=>{const t=[...n.messages].reverse().find(l=>l.sender==="user");t&&c(t.content)},W=t=>{c(t)},R=async()=>{j(t=>({...t,isLoadingSuggestions:!0}));try{const t=await we("https://2kdtuncj36tas5twwm7dsgpz5y0bkfkw.lambda-url.us-east-1.on.aws",{conversationId:b.conversationId,major:(s==null?void 0:s.majorId)||"",subField:(s==null?void 0:s.subId)||"",suggestCount:3});j(l=>({...l,suggestions:t,isLoadingSuggestions:!1}))}catch(t){j(l=>({...l,isLoadingSuggestions:!1,suggestionsError:t.message}))}},H=t=>{M(t)},J=()=>{if(n.messages.length>0){const t=[...n.messages].reverse().find(l=>l.sender==="user");t&&M(t.content)}},V=()=>{R()},Q=t=>{t.sender==="ai"&&S&&w&&a({title:"ë¶ë§ˆí¬ ê¸°ëŠ¥",description:"ê³§ êµ¬í˜„ë  ì˜ˆì •ì…ë‹ˆë‹¤.",variant:"default"})},X=()=>{r(`/categories/${s==null?void 0:s.majorId}`)},Z=t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),M())};o.useEffect(()=>{const t=l=>{if((l.ctrlKey||l.metaKey)&&l.key==="Enter"&&(l.preventDefault(),u.trim()&&!b.isStreaming&&M()),(l.ctrlKey||l.metaKey)&&l.key==="k"){l.preventDefault();const C=document.querySelector('[data-testid="input-message"]');C==null||C.focus()}(l.ctrlKey||l.metaKey)&&l.key==="l"&&(l.preventDefault(),z())};return document.addEventListener("keydown",t),()=>document.removeEventListener("keydown",t)},[u,b.isStreaming]);const G=t=>t?t<1e3?`${t}ms`:`${(t/1e3).toFixed(1)}s`:"";return!S||!w?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-cyan-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h1",{className:"text-2xl font-bold text-text-primary mb-4",children:"ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤"}),e.jsx(p,{onClick:()=>r("/"),"data-testid":"button-go-home",children:"í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°"})]})}):e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-cyan-50",children:e.jsxs("div",{className:"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[e.jsxs("div",{className:"mb-6",children:[e.jsxs(p,{variant:"ghost",onClick:X,className:"mb-4","data-testid":"button-back-categories",children:[e.jsx(re,{className:"w-4 h-4 mr-2"}),"ì¹´í…Œê³ ë¦¬ë¡œ ëŒì•„ê°€ê¸°"]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"text-3xl",children:S.emoji}),e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold text-text-primary",children:[S.name," ",">"," ",w.name]}),e.jsx("p",{className:"text-gray-600",children:"AI íŠœí„°ì™€ í•¨ê»˜ í•™ìŠµí•˜ì„¸ìš”"})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[h.error&&e.jsxs(p,{variant:"outline",size:"sm",onClick:q,className:"flex items-center space-x-2","data-testid":"button-retry",children:[e.jsx(le,{className:"w-4 h-4"}),e.jsx("span",{children:"ì¬ì‹œë„"})]}),e.jsxs(p,{variant:"outline",onClick:z,className:"flex items-center space-x-2","data-testid":"button-clear-chat",children:[e.jsx(ce,{className:"w-4 h-4"}),e.jsx("span",{children:"ëŒ€í™” ì´ˆê¸°í™”"})]})]})]}),e.jsx("div",{className:"mt-4",children:e.jsx(je,{})})]}),e.jsx($,{className:"mb-6 bg-amber-50 border-amber-200",children:e.jsxs(T,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-3",children:[e.jsx(ie,{className:"w-5 h-5 text-amber-600"}),e.jsx("h3",{className:"font-semibold text-amber-800",children:"ì§ˆë¬¸ ì˜ˆì‹œ"})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:w.sampleQuestions.map((t,l)=>e.jsx(p,{variant:"outline",size:"sm",onClick:()=>f?m.send(t):W(t),className:"text-xs bg-white hover:bg-amber-100 border-amber-300 text-amber-700","data-testid":`button-sample-${l}`,disabled:f?m.loading:!1,children:t},l))})]})}),e.jsx("div",{className:"mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200",children:e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("span",{className:"text-sm font-medium text-blue-800",children:"ì±„íŒ… ëª¨ë“œ:"}),e.jsx(p,{variant:f?"outline":"default",size:"sm",onClick:()=>v(!1),className:"text-xs",children:"ê¸°ì¡´ ë°©ì‹"}),e.jsx(p,{variant:f?"default":"outline",size:"sm",onClick:()=>v(!0),className:"text-xs",children:"SSE ìŠ¤íŠ¸ë¦¬ë°"})]})}),f?e.jsx($,{className:"mb-6 bg-white",children:e.jsxs("div",{className:"h-96 flex flex-col",children:[e.jsx(Se,{messages:m.messages,loading:m.loading}),m.error&&e.jsxs("div",{className:"p-4 bg-red-50 border-t border-red-200 text-red-700 text-sm flex items-center justify-between",children:[e.jsxs("span",{children:["âŒ ",m.error]}),e.jsx(p,{size:"sm",variant:"outline",onClick:()=>window.location.reload(),className:"text-red-700 border-red-300 hover:bg-red-100",children:"ìƒˆë¡œê³ ì¹¨"})]}),!m.loading&&m.suggestions.length>0&&e.jsx(ke,{items:m.suggestions,onSelect:t=>m.send(t)}),e.jsx(Ne,{onSend:t=>m.send(t),onCancel:m.cancel,loading:m.loading})]})}):e.jsxs(e.Fragment,{children:[e.jsx($,{className:"mb-6 bg-white",children:e.jsx(T,{className:"p-0",children:e.jsxs("div",{className:"h-96 overflow-y-auto p-4 space-y-4","data-testid":"chat-messages",children:[n.messages.map(t=>e.jsx("div",{className:`flex ${t.sender==="user"?"justify-end":t.sender==="system"?"justify-center":"justify-start"}`,children:e.jsxs("div",{className:`max-w-xs lg:max-w-md ${t.sender==="user"?"bg-primary text-white":t.sender==="system"?"bg-amber-100 text-amber-800 text-sm":"bg-gray-100 text-gray-800"} px-4 py-2 rounded-lg shadow-sm`,"data-testid":`message-${t.sender}-${t.id}`,children:[e.jsx("p",{className:"whitespace-pre-wrap",children:t.content}),e.jsx("div",{className:"flex items-center justify-between mt-1",children:e.jsxs("p",{className:`text-xs ${t.sender==="user"?"text-blue-100":t.sender==="system"?"text-amber-600":"text-gray-500"}`,children:[t.timestamp.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),t.processingTime&&e.jsxs("span",{className:"ml-2",children:["(",G(t.processingTime),")"]})]})}),t.sender==="ai"&&e.jsx("div",{className:"mt-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(be,{messageId:t.id}),e.jsx(p,{variant:"ghost",size:"sm",onClick:()=>Q(t),className:"text-yellow-600 hover:text-yellow-800","data-testid":`bookmark-${t.id}`,children:e.jsx(ue,{className:"w-3 h-3"})})]})})]})},t.id)),n.isTyping&&x&&e.jsx("div",{className:"flex justify-start",children:e.jsx("div",{className:"bg-gray-100 text-gray-800 px-4 py-2 rounded-lg shadow-sm max-w-xs lg:max-w-md",children:e.jsx(fe,{text:x,speed:30,onComplete:F})})}),(b.isStreaming||b.answer||b.streamError)&&e.jsx(pe,{state:b,onSuggestionClick:H,onRetryStream:J,onRetrySuggestions:V}),h.error&&e.jsx("div",{className:"flex justify-center",children:e.jsxs("div",{className:"bg-red-50 text-red-700 px-4 py-2 rounded-lg flex items-center space-x-2",children:[e.jsx(K,{className:"w-4 h-4"}),e.jsx("span",{children:h.error})]})}),e.jsx("div",{ref:E})]})})}),e.jsx($,{className:"bg-white",children:e.jsxs(T,{className:"p-4",children:[e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(A,{value:u,onChange:t=>c(t.target.value),onKeyPress:Z,placeholder:"ê¶ê¸ˆí•œ ê²ƒì„ ì§ˆë¬¸í•´ë³´ì„¸ìš”...",className:"flex-1",disabled:b.isStreaming,"data-testid":"input-message"}),e.jsx(p,{onClick:()=>M(),disabled:!u.trim()||b.isStreaming,className:"bg-primary text-white","data-testid":"button-send",children:b.isStreaming?e.jsx(oe,{className:"w-4 h-4 animate-spin"}):e.jsx(O,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"mt-2 text-xs text-gray-500 space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Enterë¥¼ ëˆŒëŸ¬ ì „ì†¡ â€¢ Shift+Enterë¡œ ì¤„ë°”ê¿ˆ"}),e.jsx("span",{className:"text-gray-400",children:"Ctrl+K: ì…ë ¥ì°½ í¬ì»¤ìŠ¤"})]}),e.jsx("div",{className:"text-gray-400",children:"Ctrl+Enter: ë¹ ë¥¸ ì „ì†¡ â€¢ Ctrl+L: ëŒ€í™” ì´ˆê¸°í™”"})]})]})})]})]})})}export{Be as default};
